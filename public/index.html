<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PsicoFunnel — Creador</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<style>
/* =========================
   PsicoFunnel — Home
   ========================= */
:root{
  --bg:#f7f9fc;
  --bg-grad: radial-gradient(1200px 800px at 20% -10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
             radial-gradient(900px 700px at 100% 0%, #f0fbff 0%, rgba(240,251,255,0) 60%);
  --card: rgba(255,255,255,.62);
  --border: rgba(255,255,255,.38);
  --text:#0b1220;
  --muted:#6b7280;
  --primary:#0ea5e9;
  --accent:#0b5fff;
  --success:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;
  --glass-blur: 18px;
  --radius-2xl: 24px;
  --radius-xl: 18px;
  --radius-lg: 14px;
  --shadow-lg: 0 20px 60px rgba(15,23,42,.12);
  --shadow-md: 0 10px 30px rgba(2,6,23,.10);
  --shadow-sm: 0 6px 16px rgba(2,6,23,.08);
  --ring: 0 0 0 8px rgba(14,165,233,.15);
  --ring-strong: 0 0 0 10px rgba(14,165,233,.22);
  --font: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  --nav-h: 68px;
  --max-w: 1180px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:var(--font);
  color:var(--text);
  background: var(--bg);
  background-image: var(--bg-grad);
  background-attachment: fixed;
}
.container{max-width:var(--max-w); margin:0 auto; padding:0 20px}
.glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  border-radius:var(--radius-2xl);
  box-shadow:var(--shadow-lg);
}
.btn{
  display:inline-flex; align-items:center; gap:10px;
  padding:12px 16px; border-radius:999px; border:0; cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--primary));
  color:#fff; font-weight:700; letter-spacing:.2px; text-decoration:none;
  box-shadow:0 12px 28px rgba(14,165,233,.35);
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
  font-size:14px;
}
.btn:hover{transform:translateY(-1px); filter:saturate(1.1)}
.btn:active{transform:translateY(0); box-shadow:0 10px 20px rgba(14,165,233,.3)}
.btn.ghost{
  background:transparent; color:var(--accent); border:1px solid rgba(11,95,255,.25);
  box-shadow:var(--shadow-sm);
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 12px; border-radius:999px;
  background:rgba(14,165,233,.12); color:var(--accent); font-weight:700; font-size:12px;
  border:1px solid rgba(11,95,255,.25);
}
.pills{display:flex; gap:8px; flex-wrap:wrap}
.pill{
  padding:8px 12px; border-radius:999px; border:1px solid rgba(11,95,255,.18);
  background:rgba(255,255,255,.6); color:#0b3aa6; font-weight:600; cursor:pointer;
  transition:transform .1s ease, background .2s ease;
  font-size:12px;
}
.pill:hover{transform:translateY(-1px); background:#fff}
.hint{color:var(--muted); font-size:14px}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(11,95,255,.18),rgba(14,165,233,.18)); margin:28px 0}

/* Nav */
.nav{
  position:sticky; top:0; z-index:50; height:var(--nav-h);
  display:flex; align-items:center; backdrop-filter:saturate(1.2) blur(14px);
  -webkit-backdrop-filter:saturate(1.2) blur(14px);
  border-bottom:1px solid rgba(11,95,255,.08);
}
.nav .inner{display:flex; align-items:center; justify-content:space-between}
.brand{ display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.2px; }
.brand .logo{
  width:36px; height:36px; border-radius:14px;
  background:linear-gradient(135deg,#0b5fff 0%, #0ea5e9 100%);
  box-shadow:0 10px 30px rgba(11,95,255,.28), inset 0 0 20px rgba(255,255,255,.35);
  position:relative; overflow:hidden;
}
.brand .logo::after{
  content:""; position:absolute; inset:-40% -20% auto auto; width:120%; height:120%;
  background:linear-gradient(60deg,rgba(255,255,255,.55),rgba(255,255,255,0));
  transform:rotate(12deg);
}
.nav .tabs{display:flex; gap:8px; align-items:center}
.tab{
  padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
  background:rgba(255,255,255,.7); border:1px solid rgba(11,95,255,.15); cursor:pointer;
  text-decoration:none; color:inherit;
}
.tab.active{background:linear-gradient(135deg,rgba(11,95,255,.15), rgba(14,165,233,.15)); color:#0b3aa6}
.login{display:flex; align-items:center; gap:10px; margin-left:10px}
.logged #loginStatus{color:var(--success); font-weight:700}

/* Header */
.header-hero{ padding:30px 0 16px; text-align:center; }
.title{
  font-size: clamp(26px, 4vw, 40px);
  line-height:1.05; font-weight:900; letter-spacing:-.02em; margin:10px 0 8px;
  background:linear-gradient(120deg,#0b5fff 0%,#0ea5e9 35%,#0b5fff 70%);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  position:relative; display:inline-block;
}
.title::after{
  content:""; display:block; height:7px; border-radius:999px; margin:8px auto 0;
  width:58%; background:linear-gradient(90deg,rgba(11,95,255,.45),rgba(14,165,233,.35)); filter: blur(2px);
}
.header-hero .subtitle{color:var(--muted); max-width:780px; margin:8px auto 0; font-size:13px}

/* Plantillas */
.templates{ margin-top:14px; display:flex; justify-content:center; gap:16px; flex-wrap:wrap }
.template{ display:flex; flex-direction:column; align-items:center; gap:8px; width:92px; cursor:pointer; user-select:none; }
.icon-glass{
  width:62px; height:62px; border-radius:50%;
  background: radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.55) 45%, rgba(255,255,255,.35) 100%),
              linear-gradient(135deg, rgba(11,95,255,.18), rgba(14,165,233,.18));
  border:1px solid rgba(11,95,255,.25);
  backdrop-filter:saturate(1.35) blur(12px); -webkit-backdrop-filter:saturate(1.35) blur(12px);
  box-shadow: var(--shadow-md), inset 0 1px 0 rgba(255,255,255,.6);
  display:grid; place-items:center;
  transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.icon-glass:hover{ transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: rgba(11,95,255,.35) }
.template .name{font-size:11px; font-weight:700; color:#0b3aa6; text-align:center}

/* Chat */
.canvas{ min-height: calc(100vh - var(--nav-h) - 176px); display:grid; place-items:stretch; margin-top:8px; }
.chat{
  position:relative; overflow:hidden; border-radius:var(--radius-2xl);
  padding:0; display:grid; grid-template-rows: 1fr auto; height:64vh;
}
.chat .bg{ position:absolute; inset:0; pointer-events:none;
  background: radial-gradient(800px 600px at 15% 20%, rgba(11,95,255,.12), transparent 60%),
              radial-gradient(700px 600px at 85% 10%, rgba(14,165,233,.10), transparent 60%),
              radial-gradient(900px 700px at 50% 100%, rgba(11,95,255,.10), transparent 60%); }
.chat .surface{ position:absolute; inset:0; padding:14px; display:flex; flex-direction:column; }
.chat .pane{ flex:1; overflow:auto; padding:6px; display:flex; flex-direction:column; gap:8px; }
.msg{
  max-width:68ch; padding:10px 12px; border-radius:14px; box-shadow:var(--shadow-sm);
  border:1px solid rgba(11,95,255,.12); background:#fff; line-height:1.35; font-size:14px;
}
.msg.user{ align-self:flex-end; background:linear-gradient(135deg, #ffffff, #f6fbff); border-color:rgba(14,165,233,.25) }
.msg.assistant{ align-self:flex-start }
.msg.system{ align-self:center; font-size:12px; color:var(--muted); background:rgba(255,255,255,.6) }

.composer{
  display:flex; gap:8px; padding:8px; border-top:1px solid rgba(11,95,255,.1);
  background:rgba(255,255,255,.75); backdrop-filter: blur(8px);
  border-bottom-left-radius:var(--radius-2xl); border-bottom-right-radius:var(--radius-2xl);
}
.input{ flex:1; display:flex; align-items:center; gap:8px; padding:8px 10px;
  background:#fff; border:1px solid rgba(11,95,255,.18); border-radius:12px; box-shadow: inset 0 1px 0 rgba(255,255,255,.7); }
.input textarea{ width:100%; border:0; outline:0; resize:none; max-height:160px; font: 500 14px/1.4 var(--font); color:var(--text); }
.chips{display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 0}
.chip{ padding:6px 10px; border-radius:999px; background:rgba(14,165,233,.12);
  border:1px solid rgba(11,95,255,.25); color:#0b3aa6; font-weight:700; font-size:12px; cursor:pointer; }

/* Secciones inferiores */
.section{padding:24px 0}
.grid{display:grid; gap:14px}
.grid.cards{grid-template-columns: repeat(auto-fill, minmax(260px, 1fr))}
.card{padding:14px; border-radius:var(--radius-xl); background:rgba(255,255,255,.78); border:1px solid rgba(11,95,255,.14); box-shadow:var(--shadow-sm); font-size:14px}
.card .k{font-weight:700; font-size:12px; color:#0b3aa6}
.card .v{font-weight:600}

/* Modales base */
.modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; }
.modal.active{display:flex}
.modal .scrim{position:absolute; inset:0; background:rgba(2,6,23,.35); backdrop-filter: blur(6px)}
.dialog{
  position:relative; width:min(720px, 96vw); max-height:86vh; overflow:auto; padding:16px;
  border-radius:var(--radius-2xl); box-shadow:var(--shadow-lg); background:rgba(255,255,255,.9);
  border:1px solid rgba(11,95,255,.25);
}

/* Preview modal */
.preview-modal .sheet{
  position:relative; width:min(1200px,96vw); height:min(86vh, 900px); background:rgba(255,255,255,.96);
  border-radius:var(--radius-2xl); border:1px solid rgba(11,95,255,.25); box-shadow:var(--shadow-lg); overflow:hidden;
  display:grid; grid-template-rows: auto 1fr;
}
.preview-modal .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px;
  background:linear-gradient(0deg, rgba(255,255,255,.8), rgba(255,255,255,.9));
  border-bottom:1px solid rgba(11,95,255,.15);
}
.preview-modal .actions{display:flex; gap:8px; flex-wrap:wrap}
.preview-modal iframe{ width:100%; height:100%; border:0; }
.preview-modal pre{
  display:none; margin:0; padding:12px; height:100%; overflow:auto; background:#0b1220; color:#e5e7eb;
  font: 12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
.preview-modal.show-code iframe{display:none}
.preview-modal.show-code pre{display:block}
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- NAV -->
  <div class="nav glass">
    <div class="inner container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>PsicoFunnel</div>
        <span class="badge" id="healthBadge" title="Estado de API">● Listo</span>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <a class="tab active" role="tab" aria-selected="true" href="/">Creador</a>
        <a class="tab" role="tab" href="/crm" id="navLeads">Leads</a>
        <a class="tab" role="tab" href="/secuencias" id="navSeq">Secuencias</a>
        <a class="tab" role="tab" href="/analytics" id="navAnalytics">Analytics</a>
        <a class="tab" role="tab" href="/publish-tester" id="navDominio" title="Configurar dominio">Dominio</a>
      </div>
      <div class="login">
        <div id="btnGoogle"></div>
        <span class="hint" id="loginStatus">No has iniciado sesión</span>
      </div>
    </div>
  </div>

  <!-- MODAL LOGIN -->
  <div class="modal" id="loginModal" aria-hidden="true" role="dialog">
    <div class="scrim" data-close-login></div>
    <div class="dialog glass" style="max-width:560px">
      <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:12px; padding:6px">
        <div class="logo" aria-hidden="true"></div>
        <h2 style="margin:0; font-size:20px; letter-spacing:-.02em">Inicia sesión para continuar</h2>
        <p class="hint" style="margin:0">Conéctate con Google para generar tu landing y asociarla a tu cuenta.</p>
        <div id="btnGoogleModal" style="display:flex; justify-content:center"></div>
        <div class="hint" id="loginStatusModal">Tu correo no está conectado.</div>
        <button class="btn ghost" data-close-login style="margin-top:6px">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header-hero container">
    <h1 class="title">¿Qué funnel vamos a diseñar hoy?</h1>
    <p class="subtitle">Usá el chat para describir tu landing o elegí una plantilla. Al guardar tu brief inicial, podremos crear tu web y publicarla en tu subdominio.</p>

    <div class="templates" id="templates">
      <div class="template" data-template="optin" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Crea una landing opt-in simple para captar emails, con un lead magnet descargable.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5l9 6 9-6" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
          </svg>
        </div>
        <div class="name">Opt-in</div>
      </div>

      <div class="template" data-template="vsl" data-sections='["hero","how","leadform","pricing","faq","footer"]' data-prompt="Crea una página VSL con un video central, bullets, prueba social mínima y CTA al formulario.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M10 9.5l5 2.5-5 2.5V9.5z" fill="#0b5fff"/>
          </svg>
        </div>
        <div class="name">VSL</div>
      </div>

      <div class="template" data-template="webinar" data-sections='["hero","steps","leadform","faq","footer"]' data-prompt="Crea registro a webinar con fecha/horario, bullets de valor y agenda de 3 puntos.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="5" width="18" height="14" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M3 9h18" stroke="#0b5fff" stroke-width="1.4"/>
            <circle cx="9" cy="13" r="1.4" fill="#0b5fff"/><circle cx="15" cy="13" r="1.4" fill="#0ea5e9"/>
          </svg>
        </div>
        <div class="name">Webinar</div>
      </div>
    </div>

    <div style="margin-top:14px; display:flex; gap:8px; justify-content:center;">
      <button class="btn" id="openBrief">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        Guardar brief
      </button>
      <button class="btn ghost" id="loadDemo">Cargar demo rápida</button>
      <a class="btn ghost" href="/publish-tester" title="Configurar tu dominio">Ir a Dominio</a>
    </div>
  </header>

  <!-- CHAT -->
  <main class="container canvas">
    <section class="chat glass" aria-label="Creador tipo chat">
      <div class="bg" aria-hidden="true"></div>
      <div class="surface">
        <div id="pane" class="pane" role="log" aria-live="polite" aria-label="Mensajes del chat">
          <div class="msg system">Consejo: elegí una plantilla para autocompletar el prompt o escribí libremente.</div>
        </div>
        <div class="composer">
          <div class="input" style="flex:1">
            <textarea id="composer" rows="1" placeholder="Describe tu funnel… (Shift+Enter para salto de línea)"></textarea>
          </div>
          <button class="btn" id="send" aria-label="Enviar prompt y generar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 12l16-8-7 16-2-7-7-1z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
            Generar
          </button>
        </div>
        <div class="chips" id="chips">
          <div class="chip">Añade FAQ</div>
          <div class="chip">Incluye garantía 7 días</div>
          <div class="chip">Tono profesional y claro</div>
          <div class="chip">CTA con beneficio</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ÚLTIMAS LANDINGS + IDEAS -->
  <section class="container section" id="recentSection">
    <h3 style="margin:0 0 8px; font-size:18px">Últimas landings generadas</h3>
    <div class="grid cards" id="recentGrid" aria-live="polite"></div>
    <hr class="sep">
    <h3 style="margin:0 0 8px; font-size:18px">Ideas y plantillas recomendadas</h3>
    <div class="grid cards" id="ideasGrid">
      <div class="card"><div class="k">Opt-in con lead magnet</div><div class="hint">Ebook, checklist o mini-curso. Conversión esperada 3–7% con tráfico templado.</div></div>
      <div class="card"><div class="k">VSL con CTA a agenda</div><div class="hint">Video 3–7 min + prueba social breve. Ideal coaches/agencias.</div></div>
      <div class="card"><div class="k">Webinar evergreen</div><div class="hint">Registro + confirmación + replay. Secuencia 0/60/120s.</div></div>
      <div class="card"><div class="k">Checkout + garantía</div><div class="hint">Precio claro, bullets de valor, preguntas frecuentes.</div></div>
    </div>
  </section>

  <!-- MODAL BRIEF (onboarding) -->
  <div class="modal" id="briefModal" aria-hidden="true" aria-labelledby="briefTitle" role="dialog">
    <div class="scrim" data-close></div>
    <div class="dialog">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px">
        <div>
          <div class="badge">Brief inicial</div>
          <h2 id="briefTitle" style="margin:8px 0 2px; font-size:20px">Contanos tu marca</h2>
          <div class="hint" style="font-size:13px">Estos datos se usarán como base para tus landings y para tu subdominio.</div>
        </div>
        <button class="btn ghost" data-close aria-label="Cerrar">Cerrar</button>
      </div>
      <form id="briefForm" class="form-grid">
        <div>
          <label class="label">Nombre de marca</label>
          <input class="input-txt" name="brand_name" required placeholder="Ej. PsicoFunnel">
        </div>
        <div>
          <label class="label">Nicho</label>
          <input class="input-txt" name="niche" placeholder="Ej. Coaching de hábitos">
        </div>
        <div>
          <label class="label">Objetivo</label>
          <input class="input-txt" name="goal" placeholder="Ej. Captar leads para sesión diagnóstica">
        </div>
        <div>
          <label class="label">Tono</label>
          <input class="input-txt" name="tone" placeholder="Ej. Positivo, claro, sin promesas vacías">
        </div>
        <div class="full" style="display:flex; gap:8px; align-items:center">
          <div>
            <label class="label">Color primario</label>
            <input class="input-txt" name="color_primary" value="#0ea5e9">
          </div>
          <div>
            <label class="label">Color acento</label>
            <input class="input-txt" name="color_accent" value="#0b5fff">
          </div>
          <div style="flex:1">
            <label class="label">Estilo / keywords</label>
            <input class="input-txt" name="style_keywords" placeholder="liquid glass, minimalista, premium">
          </div>
        </div>
        <div>
          <label class="label">Precio (opcional)</label>
          <input class="input-num" type="number" min="0" step="1" name="offer_price" placeholder="49">
        </div>
        <div>
          <label class="label">Garantía (opcional)</label>
          <input class="input-txt" name="offer_guarantee" placeholder="Garantía 7 días">
        </div>
        <div class="full" style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px">
          <button type="button" class="btn ghost" id="briefReset">Reset</button>
          <button type="submit" class="btn">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL PREVIEW -->
  <div class="modal preview-modal" id="previewModal" aria-hidden="true" role="dialog">
    <div class="sheet">
      <div class="bar">
        <div class="pills">
          <span class="pill">Preview</span>
          <span class="pill" id="toggleCode">Ver código</span>
        </div>
        <div class="actions">
          <button class="btn ghost" id="downloadHTML">Descargar HTML</button>
          <button class="btn ghost" id="openNewTab">Abrir en pestaña</button>
          <button class="btn" id="closePreview">Cerrar</button>
        </div>
      </div>
      <iframe id="previewFrame" title="Vista previa de la landing"></iframe>
      <pre id="codeBox"></pre>
    </div>
  </div>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script defer>
/* =========================
   PsicoFunnel — Home JS
   ========================= */
const MAKE_URL = 'https://hook.us2.make.com/un34h9dqpi6qxcpclphk9rfav8fcvo1v';
const CRM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyRp2Y8yhJ1k4M5ZBDjQ1iC7x5KJW8wZvMiE9s8vh3cX_icO7K_4pJEbTxbCIqyDdXKLQ/exec';
const CRM_KEY = 'pon-un-secreto-simple-aqui';

const CLIENT_ID = "668657005630-cljvl7bjqt10iim27aptl60bjqibn5vl.apps.googleusercontent.com";
let ID_TOKEN = null;
let USER_EMAIL = null;
let USER_NAME = null;

const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

/* ==== helpers ==== */
function b64urlToUtf8(b64url){
  let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/'); const pad = b64.length % 4; if(pad) b64 += '='.repeat(4-pad);
  const bin = atob(b64);
  try{ return decodeURIComponent(Array.from(bin, c => '%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join('')); }catch(_){ return bin; }
}
function decodeJwtPayload(token){ try{ return JSON.parse(b64urlToUtf8(token.split('.')[1]||'')) }catch(_){ return {} } }
function slugify(s){
  return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9-]+/g,'-').replace(/--+/g,'-').replace(/^-+|-+$/g,'');
}
function validHex(s){ return /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test((s||'').trim()); }

function setLoginModal(open){ const m=$('#loginModal'); m.classList.toggle('active', !!open); m.setAttribute('aria-hidden', open?'false':'true'); }
function setModal(open){ const m=$('#briefModal'); m.classList.toggle('active', !!open); m.setAttribute('aria-hidden', open?'false':'true'); if(open){ setTimeout(()=> $("[name='brand_name']", m)?.focus(), 50) } }
function setPreview(open){ const m=$('#previewModal'); m.classList.toggle('active', !!open); m.setAttribute('aria-hidden', open?'false':'true'); }

/* ==== API ==== */
async function apiWhoAmI(idToken){
  const u = new URL(CRM_ENDPOINT);
  u.searchParams.set('action','whoami');
  u.searchParams.set('id_token', idToken);
  const r = await fetch(u); return r.json();
}

/* ==== stores ==== */
const BriefStore = {
  key: 'pf_brief_v1',
  get(){ try { return JSON.parse(localStorage.getItem(this.key)||'null') } catch { return null } },
  set(d){ localStorage.setItem(this.key, JSON.stringify(d||{})); },
  reset(){ localStorage.removeItem(this.key); }
};
const BrandStore = {
  key: 'pf_brand',
  get(){ try { return JSON.parse(localStorage.getItem(this.key)||'null') } catch { return null } },
  set(d){ localStorage.setItem(this.key, JSON.stringify(d||{})); },
  exists(){ return !!this.get(); }
};
const Onboarding = {
  key: 'pf_onboarding_done',
  get(){ return localStorage.getItem(this.key)==='true' },
  set(){ localStorage.setItem(this.key,'true') }
};
const RecentStore = {
  key: 'pf_recent_sites_v1',
  list(){ try { return JSON.parse(localStorage.getItem(this.key)||'[]') } catch { return [] } },
  push(item){ const arr = this.list(); arr.unshift(item); localStorage.setItem(this.key, JSON.stringify(arr.slice(0,12))); }
};
const SessionHTML = new Map();

/* ==== UI refs ==== */
const healthBadge = $('#healthBadge');
const pane = $('#pane');
const composer = $('#composer');
const sendBtn = $('#send');
const openBriefBtn = $('#openBrief');
const loadDemoBtn = $('#loadDemo');
const recentGrid = $('#recentGrid');

/* Preview modal elems */
const previewModal = $('#previewModal');
const previewFrame = $('#previewFrame');
const codeBox = $('#codeBox');
const toggleCodeBtn = $('#toggleCode');
const downloadBtn = $('#downloadHTML');
const openTabBtn = $('#openNewTab');
const closePreviewBtn = $('#closePreview');

let selectedTemplate = null;
let lastHTML = ''; let lastBlobURL = '';

/* Salud simple */
healthBadge.textContent = '● Listo';
healthBadge.style.color = 'var(--success)';

/* ==== Auth ==== */
window.addEventListener('load', async () => {
  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleSignIn });
    const btn = $('#btnGoogle'); if(btn) google.accounts.id.renderButton(btn, { theme:'outline', size:'medium', type:'standard', shape:'pill' });
    const btnM = $('#btnGoogleModal'); if(btnM) google.accounts.id.renderButton(btnM, { theme:'filled_blue', size:'large', type:'standard', shape:'pill', text:'signin_with' });
  }
  // Reusar token
  try{
    const t = localStorage.getItem('psico_id_token');
    const n = localStorage.getItem('psico_name');
    const e = localStorage.getItem('psico_email');
    if(t){
      const w = await apiWhoAmI(t).catch(()=>({ok:false}));
      if(w.ok){
        ID_TOKEN = t; USER_EMAIL = w.email || e || null; USER_NAME = n || null;
        document.body.classList.add('logged');
        const ls = $('#loginStatus'); if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;

        // Onboarding automático si nunca guardó marca/brief
        if(!BrandStore.exists() && !Onboarding.get()){
          setTimeout(()=> setModal(true), 300);
        }
      }else{
        localStorage.removeItem('psico_id_token'); localStorage.removeItem('psico_email'); localStorage.removeItem('psico_name');
      }
    }
  }catch(_){}
});

async function onGoogleSignIn(resp){
  const claims = decodeJwtPayload(resp.credential || '');
  USER_NAME  = claims.name || [claims.given_name, claims.family_name].filter(Boolean).join(' ') || null;
  USER_EMAIL = claims.email || null;

  const ls = $('#loginStatus'); if(ls) ls.textContent = 'Verificando…';
  const w = await apiWhoAmI(resp.credential).catch(()=>({ok:false}));
  if(!w.ok){ if(ls) ls.textContent = w.error || 'No autorizado'; return; }

  ID_TOKEN = resp.credential;
  USER_EMAIL = w.email || USER_EMAIL;
  localStorage.setItem('psico_id_token', ID_TOKEN);
  if(USER_EMAIL) localStorage.setItem('psico_email', USER_EMAIL);
  if(USER_NAME)  localStorage.setItem('psico_name', USER_NAME);

  document.body.classList.add('logged');
  if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
  const lsm = $('#loginStatusModal'); if(lsm) lsm.textContent = 'Conectado: ' + USER_EMAIL;
  setLoginModal(false);

  // Si es la primera vez → abrir brief
  if(!BrandStore.exists() && !Onboarding.get()){
    setTimeout(()=> setModal(true), 300);
  }
}

function ensureLogged(){
  if(ID_TOKEN) return true;
  setLoginModal(true);
  return false;
}

/* ==== Plantillas / Chips ==== */
$('#templates').addEventListener('click', (e)=>{
  if(!ensureLogged()){ addMsg('system','Inicia sesión para seleccionar una plantilla.'); return; }
  const item = e.target.closest('.template'); if(!item) return;
  selectedTemplate = { name: item.dataset.template, sections: JSON.parse(item.dataset.sections||'[]'), prompt: item.dataset.prompt || '' };
  composer.value = selectedTemplate.prompt;
  addMsg('assistant', `Plantilla <strong>${selectedTemplate.name}</strong> seleccionada. Editá el prompt y presioná <em>Generar</em>.`);
});
$('#chips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  const add = chip.textContent.trim();
  const cur = composer.value.trim();
  composer.value = cur ? cur + (cur.endsWith('.')?'':'') + ' ' + add + '.' : add + '.';
  composer.focus();
});

/* ==== Brief modal ==== */
openBriefBtn.addEventListener('click', ()=>{
  if(!ensureLogged()){ addMsg('system','Inicia sesión para completar tu brief.'); return; }
  const saved = BriefStore.get() || {};
  const modal = $('#briefModal');
  $$('[name]', modal).forEach(inp=>{ const k=inp.name; if(saved[k]!=null) inp.value = saved[k]; });
  // Si hay marca guardada, precargar brand_name
  const b = BrandStore.get(); if(b?.name){ $("[name='brand_name']", modal).value = b.name; }
  setModal(true);
});
document.addEventListener('click', (e)=>{ if(e.target.closest('[data-close]')) setModal(false); });
$('#briefReset').addEventListener('click', ()=>{
  const modal = $('#briefModal'); BriefStore.reset(); $$('[name]', modal).forEach(inp=> inp.value = '');
});
$('#briefForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());
  if(!validHex(data.color_primary)) data.color_primary = '#0ea5e9';
  if(!validHex(data.color_accent)) data.color_accent = '#0b5fff';

  // Guardar brief
  BriefStore.set(data);

  // Guardar marca (una sola vez por usuario)
  const name = String(data.brand_name||'').trim();
  if(name){
    const slug = slugify(name);
    BrandStore.set({ name, slug });
  }

  Onboarding.set();
  addMsg('assistant', '✅ Brief y marca guardados. Ya podemos generar con tus datos por defecto.');
  setModal(false);
});

/* ==== Chat / generación ==== */
const TIMEOUT_MS = 60000;
function addMsg(role, html){
  const div = document.createElement('div');
  div.className = `msg ${role}`; div.innerHTML = html; pane.appendChild(div); pane.scrollTop = pane.scrollHeight; return div;
}
function validBrief(){
  const b = BriefStore.get();
  return b && b.brand_name && slugify(b.brand_name).length >= 2;
}
async function sendToMake(payload){
  const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);
  let r;
  try{
    r = await fetch(MAKE_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=UTF-8', 'Accept':'text/html' }, body: JSON.stringify(payload), signal: ctrl.signal });
  }catch(e){ clearTimeout(t); if(e.name==='AbortError') throw new Error('Timeout del servidor (60s).'); throw new Error('No se pudo conectar: ' + e.message); }
  clearTimeout(t);
  const html = await r.text();
  if(!r.ok) throw new Error('Status ' + r.status + '. ' + html.slice(0,200));
  if(!/^<!doctype html/i.test(html) || !/<\/html>/i.test(html)) throw new Error('La respuesta no es un HTML completo.');
  return html;
}
function brandSlug(){
  const b = BrandStore.get(); if(b?.slug) return b.slug;
  const saved = BriefStore.get(); return slugify(saved?.brand_name || 'demo');
}

async function generateFromPrompt(){
  if(!ensureLogged()){ addMsg('system','Primero inicia sesión para generar.'); return; }
  if(!validBrief()){ addMsg('system','Guardá tu brief inicial (marca) antes de generar.'); setModal(true); return; }

  const text = composer.value.trim();
  if(!text){ composer.focus(); addMsg('system','Escribí un prompt o elegí una plantilla ☝️'); return; }

  const brief = BriefStore.get();
  const sections = (selectedTemplate?.sections) || ["hero","benefits","leadform","faq","footer"];
  const project_slug = brandSlug() + '-' + Math.random().toString(36).slice(2,6);

  const payload = {
    project_slug,
    brand: { name: brief.brand_name, colors: { primary: brief.color_primary, accent: brief.color_accent } },
    niche: brief.niche || 'general',
    goal: brief.goal || 'captar leads',
    tone: brief.tone || 'claro y profesional',
    offer: { price: brief.offer_price ? String(brief.offer_price) : undefined, guarantee: brief.offer_guarantee || undefined },
    sections,
    prompt: text,
    crm_endpoint: CRM_ENDPOINT,
    crm_key: CRM_KEY,
    owner_email: USER_EMAIL || undefined,
    owner_name: USER_NAME || undefined,
    id_token: ID_TOKEN
  };

  addMsg('user', text);
  const thinking = addMsg('assistant', 'Generando tu funnel… ⏳');

  try{
    // registro opcional
    try{
      await fetch(CRM_ENDPOINT, {
        method:'POST', headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
        body: JSON.stringify({ action:'registerProject', id_token: ID_TOKEN, project_slug, owner_name: USER_NAME })
      }).then(r=>r.json());
    }catch(_){}

    const html = await sendToMake(payload);
    thinking.remove();

    if(lastBlobURL) URL.revokeObjectURL(lastBlobURL);
    lastHTML = html;
    lastBlobURL = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8'}));
    SessionHTML.set(project_slug, {html, blobURL:lastBlobURL});
    RecentStore.push({ slug: project_slug, title: (brief.brand_name||'Marca') + ' — ' + (selectedTemplate?.name || 'custom'), ts: Date.now() });
    renderRecents();

    // Preview
    previewFrame.removeAttribute('sandbox'); previewFrame.srcdoc = html;
    codeBox.textContent = html;
    $('#previewModal').classList.remove('show-code');
    setPreview(true);

    addMsg('assistant', `Listo ✅ Abrí la preview para ver/descargar tu landing o andá a <a href="/publish-tester">Dominio</a> para publicarla como principal.`);
    composer.value=''; selectedTemplate = null;
  }catch(err){
    thinking.textContent = 'Hubo un problema: ' + (err.message || err);
  }
}

/* eventos UI */
sendBtn.addEventListener('click', generateFromPrompt);
composer.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); generateFromPrompt(); } });
loadDemoBtn.addEventListener('click', ()=>{
  composer.value = "Crea una landing opt-in para un checklist de productividad (3 beneficios y FAQ). Tono claro, profesional, sin promesas vacías. CTA a ‘Recibir mi checklist’.";
  addMsg('assistant','Cargué un prompt de ejemplo. ¡Dale a Generar!');
});

/* Preview actions */
toggleCodeBtn?.addEventListener('click', ()=> $('#previewModal').classList.toggle('show-code'));
downloadBtn?.addEventListener('click', ()=>{
  if(!lastHTML.trim()) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([lastHTML], {type:'text/html;charset=utf-8'}));
  a.download = 'index.html'; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
});
openTabBtn?.addEventListener('click', ()=>{ if(lastBlobURL) window.open(lastBlobURL,'_blank','noopener'); });
closePreviewBtn?.addEventListener('click', ()=> setPreview(false));

/* recientes */
function renderRecents(){
  const arr = RecentStore.list();
  recentGrid.innerHTML = '';
  if(!arr.length){
    recentGrid.innerHTML = `<div class="card"><div class="k">Aún no hay landings</div><div class="hint">Cuando generes tu primera landing, aparecerá aquí.</div></div>`;
    return;
  }
  arr.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="k">${it.title || 'Landing generada'}</div>
      <div class="hint" style="margin:6px 0 8px">Slug: <strong>${it.slug}</strong> • Fecha: ${new Date(it.ts).toLocaleString()}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" data-open="${it.slug}">Abrir</button>
        <button class="btn ghost" data-copy="${it.slug}">Copiar código</button>
      </div>`;
    recentGrid.appendChild(card);
  });
}
recentGrid.addEventListener('click', async (e)=>{
  const open = e.target.closest('[data-open]');
  const copy = e.target.closest('[data-copy]');
  if(open){
    const slug = open.getAttribute('data-open');
    const item = SessionHTML.get(slug);
    if(!item){ open.textContent='No disponible'; return; }
    window.open(item.blobURL, '_blank', 'noopener');
  }
  if(copy){
    const slug = copy.getAttribute('data-copy');
    const item = SessionHTML.get(slug);
    if(!item){ copy.textContent='No disponible'; return; }
    await navigator.clipboard.writeText(item.html);
    copy.textContent='¡Copiado!'; setTimeout(()=> copy.textContent='Copiar código', 1200);
  }
});
renderRecents();

/* login modal close */
document.addEventListener('click', (e)=>{ if(e.target.closest('[data-close-login]')) setLoginModal(false); });
</script>
</body>
</html>

