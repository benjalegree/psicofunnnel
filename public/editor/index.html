<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PsicoFunnel — Editor no-code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="color-scheme" content="light">
<style>
/* =========================
   PsicoFunnel — Estética base (copiada de Home)
   ========================= */
:root{
  --bg:#f7f9fc;
  --bg-grad: radial-gradient(1200px 800px at 20% -10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
             radial-gradient(900px 700px at 100% 0%, #f0fbff 0%, rgba(240,251,255,0) 60%);
  --card: rgba(255,255,255,.62);
  --border: rgba(255,255,255,.38);
  --text:#0b1220;
  --muted:#6b7280;
  --primary:#0ea5e9;
  --accent:#0b5fff;
  --success:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;
  --glass-blur: 18px;
  --radius-2xl: 24px;
  --radius-xl: 18px;
  --radius-lg: 14px;
  --shadow-lg: 0 20px 60px rgba(15,23,42,.12);
  --shadow-md: 0 10px 30px rgba(2,6,23,.10);
  --shadow-sm: 0 6px 16px rgba(2,6,23,.08);
  --ring: 0 0 0 8px rgba(14,165,233,.15);
  --ring-strong: 0 0 0 10px rgba(14,165,233,.22);
  --font: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  --nav-h: 68px;
  --max-w: 1180px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:var(--font);
  color:var(--text);
  background: var(--bg);
  background-image: var(--bg-grad);
  background-attachment: fixed;
}
.container{max-width:var(--max-w); margin:0 auto; padding:0 20px}
.glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  border-radius:var(--radius-2xl);
  box-shadow:var(--shadow-lg);
}
.btn{
  display:inline-flex; align-items:center; gap:10px;
  padding:10px 14px; border-radius:999px; border:0; cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--primary));
  color:#fff; font-weight:700; letter-spacing:.2px; text-decoration:none;
  box-shadow:0 12px 28px rgba(14,165,233,.35);
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
  font-size:13px;
}
.btn:hover{transform:translateY(-1px); filter:saturate(1.07)}
.btn.ghost{
  background:transparent; color:var(--accent); border:1px solid rgba(11,95,255,.25);
  box-shadow:var(--shadow-sm);
}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 12px; border-radius:999px;
  background:rgba(14,165,233,.12); color:var(--accent); font-weight:700; font-size:12px;
  border:1px solid rgba(11,95,255,.25);
}
.hint{color:var(--muted); font-size:12px}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(11,95,255,.18),rgba(14,165,233,.18)); margin:18px 0 10px}

/* NAV (igual a Home) */
.nav{
  position:sticky; top:0; z-index:60; height:var(--nav-h);
  display:flex; align-items:center; backdrop-filter:saturate(1.2) blur(14px);
  -webkit-backdrop-filter:saturate(1.2) blur(14px);
  border-bottom:1px solid rgba(11,95,255,.08);
}
.nav .inner{display:flex; align-items:center; justify-content:space-between}
.brand{ display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.2px; }
.brand .logo{
  width:36px; height:36px; border-radius:14px;
  background:linear-gradient(135deg,#0b5fff 0%, #0ea5e9 100%);
  box-shadow:0 10px 30px rgba(11,95,255,.28), inset 0 0 20px rgba(255,255,255,.35);
  position:relative; overflow:hidden;
}
.brand .logo::after{
  content:""; position:absolute; inset:-40% -20% auto auto; width:120%; height:120%;
  background:linear-gradient(60deg,rgba(255,255,255,.55),rgba(255,255,255,0));
  transform:rotate(12deg);
}
.nav .tabs{display:flex; gap:8px; align-items:center}
.tab{
  padding:8px 12px; border-radius:999px; font-weight:700; font-size:13px;
  background:rgba(255,255,255,.7); border:1px solid rgba(11,95,255,.15); cursor:pointer;
  text-decoration:none; color:inherit;
}
.tab.active{background:linear-gradient(135deg,rgba(11,95,255,.15), rgba(14,165,233,.15)); color:#0b3aa6}

/* LAYOUT DEL EDITOR */
.main-wrap{display:grid; grid-template-columns: 280px 1fr 340px; gap:14px; padding:14px 0 20px;}
@media (max-width: 1080px){ .main-wrap{ grid-template-columns: 1fr; } .panel, .right{ order:2 } .canvas{ order:1 } }
.panel, .right{
  background:rgba(255,255,255,.78); border:1px solid rgba(11,95,255,.14); border-radius:18px; box-shadow:var(--shadow-sm);
  padding:12px; min-height:220px;
}
.panel h3, .right h3{ margin:2px 0 10px; font-size:14px; color:#0b3aa6 }
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.input, .select, .input-url{
  background:#fff; border:1px solid rgba(11,95,255,.18); border-radius:10px; padding:8px 10px; font-size:13px; outline:0;
}
.input{ width:100% } .input.small{width:110px}
.select{ padding-right:26px }
.label{ font-size:12px; color:#64748b }
.group{ display:grid; gap:8px; margin-bottom:10px }
.kv{ display:grid; grid-template-columns: 90px 1fr; gap:8px; align-items:center }

.canvas{
  background:rgba(255,255,255,.78); border:1px solid rgba(11,95,255,.14); border-radius:18px; box-shadow:var(--shadow-sm);
  position:relative; overflow:hidden; min-height:70vh;
}
.toolbar{
  display:flex; gap:8px; padding:8px; border-bottom:1px solid rgba(11,95,255,.12);
  background:linear-gradient(0deg, rgba(255,255,255,.82), rgba(255,255,255,.95));
  align-items:center; justify-content:space-between;
}
.toolbar .left, .toolbar .right { display:flex; gap:8px; align-items:center; flex-wrap:wrap }

/* Iframe */
#stage{ width:100%; height: calc(80vh - 48px); border:0; background:#fff }
.stage-wrap{position:relative}
.stage-help{ position:absolute; right:8px; bottom:8px; background:rgba(255,255,255,.9); border:1px solid rgba(11,95,255,.18); border-radius:10px; padding:6px 8px; font-size:12px; }

/* Bloques PF (en el iframe, se les aplica borde/handle vía CSS-inject) */
.inspector{ display:grid; gap:8px }
.block-actions{ display:flex; gap:6px; flex-wrap:wrap }
.mini{ font-size:12px; padding:6px 10px }
.grid3{ display:grid; gap:8px; grid-template-columns: repeat(3, 1fr) }
.color{ width:32px; height:32px; border-radius:10px; border:1px solid rgba(11,95,255,.18); background:#fff; padding:0 }

/* Modal pegar/cargar */
.modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:90; }
.modal.active{display:flex}
.modal .scrim{position:absolute; inset:0; background:rgba(2,6,23,.35); backdrop-filter: blur(6px)}
.dialog{
  position:relative; width:min(920px, 96vw); max-height:86vh; overflow:auto; padding:0;
  border-radius:20px; box-shadow:var(--shadow-lg); background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.86));
  border:1px solid rgba(11,95,255,.2);
}
.dialog .head{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid rgba(11,95,255,.12) }
.dialog .body{ padding:12px }
textarea.big{ width:100%; min-height:50vh; border:1px solid rgba(11,95,255,.16); border-radius:12px; padding:10px; font: 13px/1.45 var(--font) }

/* Cards de recientes */
.cards{ display:grid; gap:10px }
.card{
  padding:12px; border-radius:14px; background:rgba(255,255,255,.78);
  border:1px solid rgba(11,95,255,.14); box-shadow:var(--shadow-sm); font-size:13px
}
.card .name{ font-weight:700; color:#0b3aa6; margin-bottom:4px }
.card .row{ justify-content:flex-start }

/* Estado */
#status{ font-size:12px; color:#475569 }
hr.thin{ border:0; height:1px; background:rgba(11,95,255,.12); margin:10px 0 }
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <!-- NAV (idéntico a Home) -->
  <div class="nav glass">
    <div class="inner container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>PsicoFunnel</div>
        <span class="badge" id="healthBadge" title="Estado de Editor">● Editor</span>
      </div>
      <div class="tabs" role="tablist" aria-label="Secciones">
        <a class="tab" role="tab" href="/">Creador</a>
        <a class="tab" role="tab" href="/crm" id="navLeads">Leads</a>
        <a class="tab" role="tab" href="/secuencias" id="navSeq">Secuencias</a>
        <a class="tab" role="tab" href="/analytics" id="navAnalytics">Analytics</a>
        <a class="tab" role="tab" href="/publish-tester" id="navDominio" title="Configurar dominio">Dominio</a>
        <a class="tab active" role="tab" aria-selected="true" href="/editor">Editor</a>
      </div>
      <div class="login">
        <div id="btnGoogleContainer">
          <div id="btnGoogle"></div>
          <span id="loginStatus">No has iniciado sesión</span>
        </div>
        <div id="profile" style="display:none">
          <div class="avatar"><img id="avatarImg" alt="Perfil" /></div>
          <div class="menu" id="profileMenu" role="menu" aria-label="Menú de usuario">
            <a href="/crm">Leads</a>
            <a href="/publish-tester">Dominio</a>
            <button id="logoutBtn">Cerrar sesión</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CUERPO -->
  <div class="container" style="padding-top:14px; padding-bottom:20px">
    <div class="main-wrap">
      <!-- PANEL IZQUIERDO: Fuentes / Tema / Recientes -->
      <aside class="panel">
        <h3>Rápido</h3>
        <div class="group">
          <div class="row">
            <button class="btn mini" id="btnPaste">Pegar HTML IA</button>
            <button class="btn mini ghost" id="btnOpenFile">Abrir .html</button>
            <input type="file" id="fileInput" accept=".html,text/html" style="display:none">
          </div>
          <div class="hint">Pega o abre el HTML que te devuelve la IA/Make (con marcas PF).</div>
        </div>

        <hr class="thin">
        <h3>Tema</h3>
        <div class="group">
          <div class="kv"><div class="label">Primario</div><input type="color" class="color" id="tPrimary"><input class="input small" id="tPrimaryHex" placeholder="#0ea5e9"></div>
          <div class="kv"><div class="label">Acento</div><input type="color" class="color" id="tAccent"><input class="input small" id="tAccentHex" placeholder="#0b5fff"></div>
          <div class="kv"><div class="label">Radio</div><input type="range" id="tRadius" min="0" max="28" step="1"><span class="hint" id="tRadiusVal">16</span></div>
          <div class="kv"><div class="label">Fuente</div>
            <select class="select" id="tFont">
              <option>Manrope</option><option>Inter</option><option>Outfit</option><option>Plus Jakarta Sans</option><option>Poppins</option>
            </select>
          </div>
        </div>

        <hr class="thin">
        <h3>Últimas 3 landings</h3>
        <div class="cards" id="recentList">
          <!-- se llena por JS -->
        </div>
      </aside>

      <!-- CANVAS CENTRO -->
      <section class="canvas">
        <div class="toolbar">
          <div class="left">
            <button class="btn mini" id="btnSave">Guardar</button>
            <button class="btn mini ghost" id="btnDownload">Descargar HTML</button>
            <button class="btn mini ghost" id="btnPreview">Nueva pestaña</button>
          </div>
          <div class="right">
            <span id="status" class="hint">Sin documento cargado.</span>
          </div>
        </div>
        <div class="stage-wrap">
          <iframe id="stage" title="Editor PsicoFunnel"></iframe>
          <div class="stage-help">Click un texto/imagen para editar. Arrastrá el <strong>handle</strong> de cada bloque para reordenar.</div>
        </div>
      </section>

      <!-- INSPECTOR DERECHO -->
      <aside class="right">
        <h3>Inspector</h3>
        <div class="inspector">
          <div id="noSelection" class="hint">Seleccioná un campo editable dentro del canvas.</div>

          <div id="textTools" style="display:none">
            <div class="label">Texto</div>
            <textarea id="txtValue" class="input" rows="5" placeholder="Escribe aquí…"></textarea>
            <div class="row">
              <button class="btn mini" id="txtApply">Aplicar</button>
              <button class="btn mini ghost" id="txtBold">Negrita</button>
              <button class="btn mini ghost" id="txtItalic">Cursiva</button>
              <button class="btn mini ghost" id="txtList">Lista</button>
              <button class="btn mini ghost" id="txtLink">Link</button>
            </div>
          </div>

          <div id="imgTools" style="display:none">
            <div class="label">Imagen</div>
            <input id="imgUrl" class="input-url input" placeholder="https://…">
            <div class="row">
              <button class="btn mini" id="imgApply">Reemplazar</button>
              <button class="btn mini ghost" id="imgUploadBtn">Subir archivo</button>
              <input type="file" id="imgFile" accept="image/*" style="display:none">
            </div>
            <div class="kv"><div class="label">Alt</div><input id="imgAlt" class="input"></div>
          </div>

          <div id="linkTools" style="display:none">
            <div class="label">Link / Botón</div>
            <div class="kv"><div class="label">Texto</div><input id="lnkText" class="input"></div>
            <div class="kv"><div class="label">URL</div><input id="lnkHref" class="input" placeholder="https://… o #id"></div>
            <div class="row"><button class="btn mini" id="lnkApply">Aplicar</button></div>
          </div>

          <hr class="thin">
          <div id="blockTools" style="display:none">
            <div class="label">Bloque PF</div>
            <div class="row">
              <span class="hint" id="blkInfo">id: —</span>
            </div>
            <div class="block-actions">
              <button class="btn mini ghost" id="blkUp">Subir</button>
              <button class="btn mini ghost" id="blkDown">Bajar</button>
              <button class="btn mini ghost" id="blkDuplicate">Duplicar</button>
              <button class="btn mini" id="blkDelete" style="background:linear-gradient(135deg,#ef4444,#f59e0b)">Eliminar</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- MODAL PEGAR HTML -->
  <div class="modal" id="pasteModal" aria-hidden="true">
    <div class="scrim"></div>
    <div class="dialog">
      <div class="head">
        <strong>Pegar HTML desde IA / Make</strong>
        <button class="btn mini ghost" id="closePaste">Cerrar</button>
      </div>
      <div class="body">
        <textarea id="pasteBox" class="big" placeholder="Pega aquí el HTML completo generado por la IA (con marcas PF)…"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="loadPasted">Cargar en Editor</button>
          <span class="hint">Acepta también ```html … ```</span>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Config / Stores (compatibles con Home)
   ========================= */
const CLIENT_ID = "668657005630-cljvl7bjqt10iim27aptl60bjqibn5vl.apps.googleusercontent.com";
const CRM_ENDPOINT = "https://script.google.com/macros/s/AKfycbyRp2Y8yhJ1k4M5ZBDjQ1iC7x5KJW8wZvMiE9s8vh3cX_icO7K_4pJEbTxbCIqyDdXKLQ/exec";

const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
const statusEl = $('#status');
const iframe = $('#stage');

const LS_LANDINGS = 'pf_landings';
function readLandings(){ try { return JSON.parse(localStorage.getItem(LS_LANDINGS) || '[]'); } catch { return []; } }
function writeLandings(list){ localStorage.setItem(LS_LANDINGS, JSON.stringify(list || [])); }

/* =========================
   Login (igual que Home)
   ========================= */
let ID_TOKEN=null, USER_EMAIL=null, USER_NAME=null, USER_PIC=null;
function b64urlToUtf8(b64url){ let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/'); const pad = b64.length % 4; if(pad) b64 += '='.repeat(4-pad); const bin = atob(b64); try{ return decodeURIComponent(Array.from(bin, c => '%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join('')); }catch(_){ return bin; } }
function decodeJwtPayload(token){ try{ return JSON.parse(b64urlToUtf8(token.split('.')[1]||'')) }catch(_){ return {} } }
async function apiWhoAmI(idToken){ const u = new URL(CRM_ENDPOINT); u.searchParams.set('action','whoami'); u.searchParams.set('id_token', idToken); const r = await fetch(u); return r.json(); }

window.addEventListener('load', async ()=>{
  if(window.google?.accounts?.id){
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleSignIn });
    const btn = $('#btnGoogle'); if(btn) google.accounts.id.renderButton(btn, { theme:'outline', size:'medium', type:'standard', shape:'pill' });
  }
  const t = localStorage.getItem('psico_id_token');
  const n = localStorage.getItem('psico_name');
  const e = localStorage.getItem('psico_email');
  const p = localStorage.getItem('psico_pic');
  if(t){
    const w = await apiWhoAmI(t).catch(()=>({ok:false}));
    if(w.ok){
      ID_TOKEN=t; USER_EMAIL=w.email||e||null; USER_NAME=n||null; USER_PIC=p||null;
      document.body.classList.add('logged');
      $('#loginStatus').textContent='Conectado: '+USER_EMAIL;
      const prof=$('#profile'); if(prof){ prof.style.display='flex'; $('#avatarImg').src=USER_PIC||''; }
    }
  }
  renderRecents();
});

async function onGoogleSignIn(resp){
  const claims = decodeJwtPayload(resp.credential || '');
  USER_NAME  = claims.name || [claims.given_name, claims.family_name].filter(Boolean).join(' ') || null;
  USER_EMAIL = claims.email || null;
  USER_PIC   = claims.picture || null;

  const ls = $('#loginStatus'); if(ls) ls.textContent = 'Verificando…';
  const w = await apiWhoAmI(resp.credential).catch(()=>({ok:false}));
  if(!w.ok){ if(ls) ls.textContent = w.error || 'No autorizado'; return; }

  ID_TOKEN = resp.credential;
  USER_EMAIL = w.email || USER_EMAIL;
  localStorage.setItem('psico_id_token', ID_TOKEN);
  if(USER_EMAIL) localStorage.setItem('psico_email', USER_EMAIL);
  if(USER_NAME)  localStorage.setItem('psico_name', USER_NAME);
  if(USER_PIC)   localStorage.setItem('psico_pic', USER_PIC);

  document.body.classList.add('logged');
  if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
  const prof=$('#profile'); if(prof){ prof.style.display='flex'; $('#avatarImg').src=USER_PIC||''; }
}

/* =========================
   Utilidades Editor
   ========================= */
function isFullHTML(t=''){ const s=String(t||'').trim(); const low=s.toLowerCase(); if(low.includes('<html')&&low.includes('</html>')) return true; const m=/```html?\s*([\s\S]*?)```/i.exec(s); return !!(m && /<\/html>/i.test(m[1])); }
function extractHTML(t=''){ const s=String(t||''); if(isFullHTML(s)) return s; const m=/```html?\s*([\s\S]*?)```/i.exec(s); return m?m[1]:s; }
function readFileAsText(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsText(file); }); }
function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
function sanitizeHTMLSimple(html){ // mini-sanitizer (allow basic tags)
  const allowed = /<(\/)?(p|br|strong|b|em|i|ul|ol|li|h1|h2|h3|h4|h5|h6|a|span)>/ig;
  return html.replace(/<script[\s\S]*?<\/script>/ig,'').replace(/ on\w+="[^"]*"/ig,'').replace(/ style="[^"]*"/ig,'');
}

/* =========================
   Carga en Iframe + Inicialización
   ========================= */
let currentSchema = null;
let selectedEl = null;
let selectedBlock = null;

async function loadHTMLIntoEditor(html){
  const clean = extractHTML(html);
  iframe.srcdoc = clean;
  statusEl.textContent='Cargando documento…';
  await new Promise(r=> iframe.addEventListener('load', r, {once:true}));
  const doc = iframe.contentDocument;

  // Inserta CSS de ayuda dentro del iframe (handles, resaltado, drag)
  injectEditorCSS(doc);

  // Envolver bloques PF por comentarios <!--PF:START ...--> ... <!--PF:END-->
  wrapPFBlocks(doc);

  // Leer/crear schema
  currentSchema = readSchema(doc) || buildSchemaFromDOM(doc);
  writeSchema(doc, currentSchema);

  // Hook de selección/edición
  bindEditingHandlers(doc);

  // Tema (tokens)
  hydrateThemeControls(doc, currentSchema?.theme || {});

  statusEl.textContent='Documento listo para editar.';
}

/* Inserta CSS auxiliar para handles/bordes en el iframe */
function injectEditorCSS(doc){
  const style = doc.createElement('style');
  style.textContent = `
  .pf-block{ position:relative; outline:1px dashed rgba(11,95,255,.35); border-radius:12px; padding:4px; margin:4px 0}
  .pf-block:hover{ outline-color: rgba(11,95,255,.7) }
  .pf-handle{
    position:absolute; left:8px; top:-12px; transform: translateY(-100%);
    background:rgba(255,255,255,.92); border:1px solid rgba(11,95,255,.26);
    color:#0b3aa6; border-radius:10px; font: 12px/1.2 sans-serif;
    padding:4px 8px; box-shadow: 0 8px 18px rgba(2,6,23,.1); cursor:grab; user-select:none;
  }
  .pf-block.drag-over{ outline:2px solid #0ea5e9 }
  [data-pf]{ outline: 0px solid transparent }
  [data-pf].pf-sel{ outline:2px solid rgba(14,165,233,.7); border-radius:8px }
  `;
  doc.head.appendChild(style);
}

/* Envuelve bloques entre comentarios PF */
function wrapPFBlocks(doc){
  const tw = doc.createTreeWalker(doc.body, NodeFilter.SHOW_COMMENT);
  const starts = [];
  const pairs = [];
  let node;
  while(node = tw.nextNode()){
    const txt = (node.nodeValue||'').trim();
    const mStart = /^PF:START\s+section="([^"]+)"(?:\s+id="([^"]+)")?/i.exec(txt);
    const mEnd   = /^PF:END/i.test(txt);
    if(mStart){ starts.push({node, section:mStart[1], id:mStart[2] || ('blk-'+Math.random().toString(36).slice(2,8))}); }
    if(mEnd){
      const start = starts.pop();
      if(start){ pairs.push({start: start.node, end: node, meta: {section:start.section, id:start.id}}); }
    }
  }
  // Wrap pares
  pairs.forEach(pair=>{
    const wrapper = doc.createElement('div');
    wrapper.className='pf-block';
    wrapper.setAttribute('data-pf-block-id', pair.meta.id);
    wrapper.setAttribute('data-pf-section', pair.meta.section);
    wrapper.setAttribute('draggable', 'true');

    const handle = doc.createElement('div');
    handle.className='pf-handle';
    handle.textContent = pair.meta.section + ' • ' + pair.meta.id;
    wrapper.appendChild(handle);

    // mover nodos entre start y end dentro del wrapper
    let n = pair.start.nextSibling;
    const end = pair.end;
    const frag = doc.createDocumentFragment();
    while(n && n !== end){
      const next = n.nextSibling;
      frag.appendChild(n);
      n = next;
    }
    wrapper.appendChild(frag);

    // Insertar wrapper donde estaba el start
    pair.start.parentNode.insertBefore(wrapper, pair.start);
    // Eliminar comentarios (los repondremos al exportar)
    pair.start.remove();
    pair.end.remove();
  });

  // DnD por bloque
  bindBlockDragDrop(doc);
}

/* DnD simple */
function bindBlockDragDrop(doc){
  let dragging=null;
  doc.addEventListener('dragstart', e=>{
    const h = e.target.closest('.pf-handle'); if(!h) return;
    dragging = h.parentElement;
    e.dataTransfer.setData('text/plain', dragging.getAttribute('data-pf-block-id'));
    e.dataTransfer.effectAllowed='move';
  });
  doc.addEventListener('dragover', e=>{
    if(!dragging) return;
    const blk = e.target.closest('.pf-block'); if(!blk || blk===dragging) return;
    e.preventDefault(); blk.classList.add('drag-over');
  });
  doc.addEventListener('dragleave', e=>{
    const blk = e.target.closest('.pf-block'); if(!blk) return; blk.classList.remove('drag-over');
  });
  doc.addEventListener('drop', e=>{
    if(!dragging) return;
    e.preventDefault();
    const blk = e.target.closest('.pf-block'); if(!blk || blk===dragging) return;
    blk.classList.remove('drag-over');
    // Inserción antes o después según posición vertical
    const rect = blk.getBoundingClientRect();
    const before = (e.clientY - rect.top) < rect.height/2;
    if(before) blk.parentNode.insertBefore(dragging, blk);
    else blk.parentNode.insertBefore(dragging, blk.nextSibling);
    dragging = null;
    // actualizar schema orden
    syncSchemaFromDOM();
    selectBlock(blk); // refresco inspector
  });
  doc.addEventListener('dragend', ()=>{ dragging=null; });
}

/* Lee schema embebido */
function readSchema(doc){
  const s = doc.getElementById('pf-schema');
  if(!s) return null;
  try{ return JSON.parse(s.textContent || s.innerText || '{}'); }catch(_){ return null; }
}

/* Crea schema básico si no existe */
function buildSchemaFromDOM(doc){
  const blocks = Array.from(doc.querySelectorAll('.pf-block')).map(blk=>{
    const id = blk.getAttribute('data-pf-block-id');
    const type = blk.getAttribute('data-pf-section') || 'section';
    const fields = {};
    blk.querySelectorAll('[data-pf]').forEach(el=>{
      const key = el.getAttribute('data-pf');
      if(key.startsWith('text:') || key.startsWith('rich:')) fields[key.split(':')[1]] = (el.innerHTML || '').trim();
      if(key.startsWith('img:')) fields[key.split(':')[1]] = (el.getAttribute('src') || '');
      if(key.startsWith('video:')) fields[key.split(':')[1]] = (el.getAttribute('src') || '');
      if(key.startsWith('link:')){
        const k = key.split(':')[1];
        fields[k+'Text'] = (el.textContent || '').trim();
        fields[k+'Url']  = (el.getAttribute('href') || '');
      }
    });
    return { id, type, fields };
  });
  // Tema por tokens
  const cs = getComputedStyle(doc.documentElement);
  const theme = {
    primary: cs.getPropertyValue('--pf-primary').trim() || '#0ea5e9',
    accent:  cs.getPropertyValue('--pf-accent').trim()  || '#0b5fff',
    font:    cs.getPropertyValue('--pf-font').trim()    || 'Manrope',
    radius:  parseInt((cs.getPropertyValue('--pf-radius')||'16').trim(),10) || 16
  };
  return { page:{title: doc.title || 'Landing IA'}, theme, blocks };
}

/* Escribe/actualiza schema en el DOM */
function writeSchema(doc, schema){
  let s = doc.getElementById('pf-schema');
  if(!s){
    s = doc.createElement('script'); s.type='application/json'; s.id='pf-schema';
    doc.body.appendChild(s);
  }
  s.textContent = JSON.stringify(schema, null, 2);
}

/* Sincroniza schema con el DOM actual de bloques y campos */
function syncSchemaFromDOM(){
  const doc = iframe.contentDocument;
  if(!currentSchema) currentSchema = buildSchemaFromDOM(doc);
  const blocks = [];
  doc.querySelectorAll('.pf-block').forEach(blk=>{
    const id = blk.getAttribute('data-pf-block-id');
    const type = blk.getAttribute('data-pf-section') || 'section';
    const fields = {};
    blk.querySelectorAll('[data-pf]').forEach(el=>{
      const key = el.getAttribute('data-pf');
      if(key.startsWith('text:')) fields[key.split(':')[1]] = el.textContent.trim();
      if(key.startsWith('rich:')) fields[key.split(':')[1]] = (el.innerHTML || '').trim();
      if(key.startsWith('img:')) fields[key.split(':')[1]] = (el.getAttribute('src') || '');
      if(key.startsWith('video:')) fields[key.split(':')[1]] = (el.getAttribute('src') || '');
      if(key.startsWith('link:')){
        const k = key.split(':')[1];
        fields[k+'Text'] = (el.textContent || '').trim();
        fields[k+'Url']  = (el.getAttribute('href') || '');
      }
    });
    blocks.push({ id, type, fields });
  });
  currentSchema.blocks = blocks;
  writeSchema(doc, currentSchema);
}

/* Controles de selección/inspector */
function bindEditingHandlers(doc){
  doc.addEventListener('click', e=>{
    const el = e.target.closest('[data-pf]');
    if(el){ selectField(el); return; }
    const blk = e.target.closest('.pf-block');
    if(blk){ selectBlock(blk); return; }
    clearSelection();
  });
}

function clearSelection(){
  const doc = iframe.contentDocument;
  doc.querySelectorAll('.pf-sel').forEach(el=> el.classList.remove('pf-sel'));
  selectedEl = null; selectedBlock = null;
  $('#noSelection').style.display='';
  $('#textTools').style.display='none';
  $('#imgTools').style.display='none';
  $('#linkTools').style.display='none';
  $('#blockTools').style.display='none';
}

function selectField(el){
  const doc = iframe.contentDocument;
  doc.querySelectorAll('.pf-sel').forEach(n=> n.classList.remove('pf-sel'));
  el.classList.add('pf-sel');
  selectedEl = el; selectedBlock = el.closest('.pf-block') || null;

  $('#noSelection').style.display='none';
  $('#blockTools').style.display= selectedBlock ? '' : 'none';
  $('#blkInfo').textContent = selectedBlock ? ('id: '+selectedBlock.getAttribute('data-pf-block-id')) : 'id: —';

  const key = el.getAttribute('data-pf');
  if(key.startsWith('text:') || key.startsWith('rich:')){
    $('#textTools').style.display='';
    $('#imgTools').style.display='none';
    $('#linkTools').style.display='none';
    $('#txtValue').value = key.startsWith('text:') ? (el.textContent||'') : (el.innerHTML||'');
  }else if(key.startsWith('img:')){
    $('#textTools').style.display='none';
    $('#imgTools').style.display='';
    $('#linkTools').style.display='none';
    $('#imgUrl').value = el.getAttribute('src') || '';
    $('#imgAlt').value = el.getAttribute('alt') || '';
  }else if(key.startsWith('link:')){
    $('#textTools').style.display='none';
    $('#imgTools').style.display='none';
    $('#linkTools').style.display='';
    $('#lnkText').value = (el.textContent||'').trim();
    $('#lnkHref').value = el.getAttribute('href') || '';
  }else{
    $('#textTools').style.display='none';
    $('#imgTools').style.display='none';
    $('#linkTools').style.display='none';
  }
}

function selectBlock(blk){
  const doc = iframe.contentDocument;
  doc.querySelectorAll('.pf-sel').forEach(n=> n.classList.remove('pf-sel'));
  selectedEl = null; selectedBlock = blk;
  $('#noSelection').style.display='none';
  $('#textTools').style.display='none';
  $('#imgTools').style.display='none';
  $('#linkTools').style.display='none';
  $('#blockTools').style.display='';
  $('#blkInfo').textContent = 'id: '+blk.getAttribute('data-pf-block-id');
}

/* =========================
   Inspector acciones
   ========================= */
$('#txtApply').addEventListener('click', ()=>{
  if(!selectedEl) return;
  const key = selectedEl.getAttribute('data-pf');
  const val = $('#txtValue').value || '';
  if(key.startsWith('text:')) selectedEl.textContent = val;
  else selectedEl.innerHTML = sanitizeHTMLSimple(val);
  syncSchemaFromDOM();
});
$('#txtBold').addEventListener('click', ()=> formatSelection('<strong>','</strong>'));
$('#txtItalic').addEventListener('click', ()=> formatSelection('<em>','</em>'));
$('#txtList').addEventListener('click', ()=> insertSnippet('<ul><li>Elemento</li><li>Elemento</li></ul>'));
$('#txtLink').addEventListener('click', ()=> insertSnippet('<a href="#" target="_self">enlace</a>'));

function formatSelection(pre,post){
  const ta = $('#txtValue'); const start = ta.selectionStart, end = ta.selectionEnd;
  const text = ta.value; const sel = text.slice(start,end);
  const out = text.slice(0,start) + pre + sel + post + text.slice(end);
  ta.value = out; ta.focus(); ta.setSelectionRange(start+pre.length, end+pre.length);
}
function insertSnippet(sn){
  const ta = $('#txtValue'); const start = ta.selectionStart, end = ta.selectionEnd;
  const text = ta.value;
  ta.value = text.slice(0,start) + sn + text.slice(end);
  ta.focus(); ta.setSelectionRange(start+sn.length, start+sn.length);
}

$('#imgApply').addEventListener('click', ()=>{
  if(!selectedEl) return;
  const url = ($('#imgUrl').value||'').trim();
  const alt = ($('#imgAlt').value||'').trim();
  if(url) selectedEl.setAttribute('src', url);
  selectedEl.setAttribute('alt', alt);
  syncSchemaFromDOM();
});
$('#imgUploadBtn').addEventListener('click', ()=> $('#imgFile').click());
$('#imgFile').addEventListener('change', async (e)=>{
  if(!selectedEl) return;
  const f = e.target.files?.[0]; if(!f) return;
  const dataUrl = await readFileAsDataURL(f); // embebe en base64 para portabilidad
  selectedEl.setAttribute('src', dataUrl);
  syncSchemaFromDOM();
  $('#imgUrl').value = dataUrl.slice(0,48)+'…';
});

$('#lnkApply').addEventListener('click', ()=>{
  if(!selectedEl) return;
  const txt = ($('#lnkText').value||'');
  const href = ($('#lnkHref').value||'');
  selectedEl.textContent = txt;
  selectedEl.setAttribute('href', href);
  syncSchemaFromDOM();
});

/* Bloque acciones */
$('#blkUp').addEventListener('click', ()=>{
  const blk = selectedBlock; if(!blk) return;
  const prev = blk.previousElementSibling; if(prev) blk.parentNode.insertBefore(blk, prev);
  syncSchemaFromDOM();
});
$('#blkDown').addEventListener('click', ()=>{
  const blk = selectedBlock; if(!blk) return;
  const next = blk.nextElementSibling; if(next) blk.parentNode.insertBefore(next, blk);
  syncSchemaFromDOM();
});
$('#blkDuplicate').addEventListener('click', ()=>{
  const blk = selectedBlock; if(!blk) return;
  const clone = blk.cloneNode(true);
  const newId = 'blk-'+Math.random().toString(36).slice(2,8);
  clone.setAttribute('data-pf-block-id', newId);
  const h = clone.querySelector('.pf-handle'); if(h) h.textContent = (clone.getAttribute('data-pf-section')||'section')+' • '+newId;
  blk.parentNode.insertBefore(clone, blk.nextSibling);
  syncSchemaFromDOM();
});
$('#blkDelete').addEventListener('click', ()=>{
  const blk = selectedBlock; if(!blk) return;
  blk.remove(); clearSelection(); syncSchemaFromDOM();
});

/* =========================
   Tema (tokens)
   ========================= */
function hydrateThemeControls(doc, theme){
  const cs = doc.defaultView.getComputedStyle(doc.documentElement);
  const curP = theme.primary || cs.getPropertyValue('--pf-primary').trim() || '#0ea5e9';
  const curA = theme.accent  || cs.getPropertyValue('--pf-accent').trim()  || '#0b5fff';
  const curR = (theme.radius ?? parseInt(cs.getPropertyValue('--pf-radius')||'16',10)) || 16;
  const curF = theme.font   || cs.getPropertyValue('--pf-font').trim() || 'Manrope';

  $('#tPrimary').value = toColor(curP); $('#tPrimaryHex').value = curP;
  $('#tAccent').value  = toColor(curA); $('#tAccentHex').value  = curA;
  $('#tRadius').value  = curR; $('#tRadiusVal').textContent = curR;
  $('#tFont').value    = curF;

  applyTheme(curP, curA, curR, curF);
}

function toColor(val){ try{ if(/^#/.test(val)) return val; }catch(_){ } return '#0ea5e9'; }
function applyTheme(p,a,r,f){
  const doc = iframe.contentDocument; if(!doc) return;
  const root = doc.documentElement;
  root.style.setProperty('--pf-primary', p);
  root.style.setProperty('--pf-accent',  a);
  root.style.setProperty('--pf-radius',  (r||16)+'px');
  root.style.setProperty('--pf-font',    f);
  // actualizar schema
  if(!currentSchema) currentSchema = { page:{title:doc.title||'Landing'}, theme:{}, blocks:[] };
  currentSchema.theme = { primary:p, accent:a, radius: parseInt(r,10)||16, font:f };
  writeSchema(doc, currentSchema);
}

$('#tPrimary').addEventListener('input', e=>{ $('#tPrimaryHex').value = e.target.value; applyTheme(e.target.value, $('#tAccent').value, $('#tRadius').value, $('#tFont').value); });
$('#tAccent').addEventListener('input', e=>{ $('#tAccentHex').value  = e.target.value; applyTheme($('#tPrimary').value, e.target.value, $('#tRadius').value, $('#tFont').value); });
$('#tPrimaryHex').addEventListener('input', e=>{ applyTheme(e.target.value, $('#tAccentHex').value, $('#tRadius').value, $('#tFont').value); });
$('#tAccentHex').addEventListener('input', e=>{ applyTheme($('#tPrimaryHex').value, e.target.value, $('#tRadius').value, $('#tFont').value); });
$('#tRadius').addEventListener('input', e=>{ $('#tRadiusVal').textContent = e.target.value; applyTheme($('#tPrimaryHex').value||$('#tPrimary').value, $('#tAccentHex').value||$('#tAccent').value, e.target.value, $('#tFont').value); });
$('#tFont').addEventListener('change', e=>{ applyTheme($('#tPrimaryHex').value||$('#tPrimary').value, $('#tAccentHex').value||$('#tAccent').value, $('#tRadius').value, e.target.value); });

/* =========================
   Guardar / Exportar
   ========================= */
$('#btnSave').addEventListener('click', ()=>{
  const html = buildExportHTML(); if(!html) return;
  // Persistir en pf_landings (actualiza o inserta)
  const list = readLandings();
  const id = 'landing-'+Date.now();
  const title = (currentSchema?.page?.title || 'Landing IA')+' — editada';
  list.unshift({ id, title, html });
  writeLandings(list.slice(0,100));
  renderRecents();
  statusEl.textContent='Guardado en “pf_landings”.';
});

$('#btnDownload').addEventListener('click', ()=>{
  const html = buildExportHTML(); if(!html) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8'}));
  a.download = (currentSchema?.page?.title ? currentSchema.page.title.replace(/\s+/g,'-').toLowerCase() : 'landing') + '.html';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
});

$('#btnPreview').addEventListener('click', ()=>{
  const html = buildExportHTML(); if(!html) return;
  const url = URL.createObjectURL(new Blob([html], {type:'text/html'}));
  window.open(url,'_blank','noopener');
  setTimeout(()=> URL.revokeObjectURL(url), 20000);
});

/* Construye el HTML final: re-inyecta comentarios PF y pf-schema actualizado */
function buildExportHTML(){
  const doc = iframe.contentDocument; if(!doc){ alert('No hay documento cargado.'); return ''; }
  syncSchemaFromDOM();

  // Clonar para export
  const clone = doc.documentElement.cloneNode(true);
  const cdoc = document.implementation.createHTMLDocument('');
  cdoc.replaceChild(cdoc.importNode(clone, true), cdoc.documentElement);

  // Reconvertir wrappers .pf-block → comentarios PF
  cdoc.querySelectorAll('.pf-block').forEach(blk=>{
    const id = blk.getAttribute('data-pf-block-id') || ('blk-'+Math.random().toString(36).slice(2,8));
    const sec = blk.getAttribute('data-pf-section') || 'section';
    const start = cdoc.createComment(`PF:START section="${sec}" id="${id}"`);
    const end   = cdoc.createComment(`PF:END`);
    const frag = cdoc.createDocumentFragment();
    // mover hijos excepto el handle
    Array.from(blk.childNodes).forEach(ch=>{
      if(ch.nodeType===1 && ch.classList.contains('pf-handle')) return;
      frag.appendChild(ch);
    });
    blk.replaceWith(start, frag, end);
  });

  // pf-schema ya está actualizado en el DOM del iframe; aseguremos que exista
  let schemaTag = cdoc.getElementById('pf-schema');
  if(!schemaTag){
    schemaTag = cdoc.createElement('script'); schemaTag.type='application/json'; schemaTag.id='pf-schema';
    cdoc.body.appendChild(schemaTag);
  }
  schemaTag.textContent = JSON.stringify(currentSchema || buildSchemaFromDOM(cdoc), null, 2);

  // DOCTYPE + HTML
  const html = '<!doctype html>\n' + cdoc.documentElement.outerHTML;
  return html;
}

/* =========================
   UI: pegar/abrir y recientes
   ========================= */
const pasteModal = $('#pasteModal');
$('#btnPaste').addEventListener('click', ()=> pasteModal.classList.add('active'));
$('#closePaste').addEventListener('click', ()=> pasteModal.classList.remove('active'));
$('#loadPasted').addEventListener('click', ()=>{
  const raw = $('#pasteBox').value || '';
  if(!raw.trim()){ alert('Pega el HTML primero.'); return; }
  pasteModal.classList.remove('active');
  loadHTMLIntoEditor(raw);
  $('#pasteBox').value='';
});
$('#btnOpenFile').addEventListener('click', ()=> $('#fileInput').click());
$('#fileInput').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const txt = await readFileAsText(f);
  loadHTMLIntoEditor(txt);
  e.target.value='';
});

function renderRecents(){
  const list = readLandings();
  const holder = $('#recentList'); holder.innerHTML='';
  if(!list.length){
    holder.innerHTML = '<div class="card"><div class="name">No hay landings guardadas</div><div class="hint">Guarda desde el Creador o desde aquí y aparecerán.</div></div>';
    return;
  }
  list.slice(0,3).forEach(item=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `
      <div class="name">${item.title || item.id}</div>
      <div class="row">
        <button class="btn mini" data-edit="${item.id}">Editar</button>
        <button class="btn mini ghost" data-prev="${item.id}">Preview</button>
      </div>
    `;
    holder.appendChild(div);
  });

  holder.addEventListener('click', e=>{
    const bEdit = e.target.closest('[data-edit]'); if(bEdit){
      const id = bEdit.getAttribute('data-edit'); const it = list.find(x=>x.id===id); if(it?.html) loadHTMLIntoEditor(it.html);
    }
    const bPrev = e.target.closest('[data-prev]'); if(bPrev){
      const id = bPrev.getAttribute('data-prev'); const it = list.find(x=>x.id===id);
      if(it?.html){ const url = URL.createObjectURL(new Blob([it.html],{type:'text/html'})); window.open(url,'_blank','noopener'); setTimeout(()=> URL.revokeObjectURL(url), 20000); }
    }
  }, {once:true});
}
</script>
</body>
</html>
