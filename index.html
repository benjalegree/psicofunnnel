<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>PsicoFunnel — Creador (MVP)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="color-scheme" content="light">
<style>
/* =========================
   PsicoFunnel — Home MVP
   Estética: liquid glass + azules
   NAV lateral mejorada (más vidrio, redondeada y pulida)
   ========================= */
:root{
  --bg:#f7f9fc;
  --bg-grad: radial-gradient(1200px 800px at 20% -10%, #eaf2ff 0%, rgba(234,242,255,0) 60%),
             radial-gradient(900px 700px at 100% 0%, #f0fbff 0%, rgba(240,251,255,0) 60%);
  --card: rgba(255,255,255,.62);
  --border: rgba(255,255,255,.38);
  --text:#0b1220;
  --muted:#6b7280;
  --primary:#0ea5e9;
  --accent:#0b5fff;
  --success:#10b981;
  --warn:#f59e0b;
  --danger:#ef4444;
  --glass-blur: 20px;
  --radius-2xl: 26px;
  --radius-xl: 18px;
  --radius-lg: 14px;
  --shadow-lg: 0 22px 68px rgba(15,23,42,.14);
  --shadow-md: 0 12px 34px rgba(2,6,23,.12);
  --shadow-sm: 0 6px 16px rgba(2,6,23,.08);
  --font: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;

  /* Sidebar */
  --sb-rail: 72px;             /* ancho colapsado */
  --sb-expanded: 288px;        /* ancho expandido */
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;overflow-x:hidden}
img,svg,video,canvas,iframe{max-width:100%;height:auto}
body{
  font-family:var(--font);
  color:var(--text);
  background:var(--bg);
  background-image:var(--bg-grad);
  background-attachment:fixed;
  padding-left:calc(var(--sb-rail) + 16px); /* deja lugar para la sidebar colapsada */
}
.container{max-width:1180px;margin:0 auto;padding:0 20px}
.glass{
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  -webkit-backdrop-filter:saturate(1.35) blur(var(--glass-blur));
  border-radius:var(--radius-2xl);
  box-shadow:var(--shadow-lg);
}
.btn{
  display:inline-flex;align-items:center;gap:10px;
  padding:14px 20px;border-radius:999px;border:0;cursor:pointer;
  background:linear-gradient(135deg,var(--accent),var(--primary));
  color:#fff;font-weight:700;letter-spacing:.2px;text-decoration:none;
  box-shadow:0 12px 28px rgba(14,165,233,.35);
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.btn:hover{transform:translateY(-1px);filter:saturate(1.1)}
.btn:active{transform:translateY(0);box-shadow:0 10px 20px rgba(14,165,233,.3)}
.btn.ghost{
  background:transparent;color:var(--accent);border:1px solid rgba(11,95,255,.25);
  box-shadow:var(--shadow-sm);
}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 12px;border-radius:999px;
  background:rgba(14,165,233,.12);color:var(--accent);font-weight:700;font-size:12px;
  border:1px solid rgba(11,95,255,.25);
}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{padding:8px 12px;border-radius:999px;border:1px solid rgba(11,95,255,.18);
  background:rgba(255,255,255,.6);color:#0b3aa6;font-weight:600;cursor:pointer;
  transition:transform .1s ease, background .2s ease;}
.pill:hover{transform:translateY(-1px);background:#fff}
.hint{color:var(--muted);font-size:14px}
hr.sep{border:0;height:1px;background:linear-gradient(90deg,rgba(11,95,255,.18),rgba(14,165,233,.18));margin:28px 0}

/* =========================
   SIDEBAR “LIQUID GLASS” — MÁS TRANSPARENTE, VIDRIO
   ========================= */
.sidebar{
  position:fixed;inset:12px auto 12px 12px;z-index:120;
  width:var(--sb-rail);
  border-radius:30px;
  overflow:hidden;
  will-change:width,transform;
  transition:width .25s ease, transform .25s ease, box-shadow .25s ease, background .25s ease;
  /* vidrio: más transparente y brillante */
  background:
    linear-gradient(180deg, rgba(255,255,255,.58), rgba(255,255,255,.42)),
    radial-gradient(120% 120% at 10% -20%, rgba(11,95,255,.16), transparent 60%),
    radial-gradient(120% 120% at 110% -10%, rgba(14,165,233,.16), transparent 60%);
  border:1px solid rgba(11,95,255,.18);
  box-shadow: 0 24px 70px rgba(2,6,23,.16), inset 0 1px 0 rgba(255,255,255,.65);
  backdrop-filter: blur(20px) saturate(1.35);
  -webkit-backdrop-filter: blur(20px) saturate(1.35);
}
.sidebar::before{
  /* brillo especular lateral para efecto vidrio */
  content:"";position:absolute;inset:0;pointer-events:none;border-radius:inherit;
  background:
    radial-gradient(60% 20% at 10% 0%, rgba(255,255,255,.45), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0) 40%, rgba(255,255,255,.08) 80%, rgba(255,255,255,0));
  mix-blend-mode:screen;
}
.sidebar::after{
  /* borde interior azulado */
  content:"";position:absolute;inset:1px;border-radius:inherit;pointer-events:none;
  box-shadow:inset 0 0 0 1px rgba(11,95,255,.12), inset 0 0 20px rgba(14,165,233,.08);
}

/* Expandido (hover desktop) */
@media (hover:hover){
  .sidebar:hover{width:var(--sb-expanded);}
}

/* Contenido */
.s-wrap{display:flex;flex-direction:column;height:100%;padding:10px;gap:12px}
.s-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 6px 2px}
.s-logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
.s-logo .logo{
  width:38px;height:38px;border-radius:14px;flex:0 0 auto;
  background:linear-gradient(135deg,#0b5fff 0%, #0ea5e9 100%);
  box-shadow:0 10px 30px rgba(11,95,255,.28), inset 0 0 20px rgba(255,255,255,.35);
  position:relative;overflow:hidden;
}
.s-logo .logo::after{
  content:"";position:absolute;inset:-40% -20% auto auto;width:120%;height:120%;
  background:linear-gradient(60deg,rgba(255,255,255,.55),rgba(255,255,255,0));transform:rotate(12deg);
}
.s-title{font-weight:900;letter-spacing:.2px;white-space:nowrap;opacity:.95}

/* Navegación */
.s-nav{display:flex;flex-direction:column;gap:10px;padding:6px}
.s-item{
  display:flex;align-items:center;gap:12px;height:48px;padding:0 10px;border-radius:16px;
  text-decoration:none;color:inherit;border:1px solid rgba(11,95,255,.14);
  background:rgba(255,255,255,.72);
  box-shadow:0 6px 16px rgba(2,6,23,.06), inset 0 1px 0 rgba(255,255,255,.6);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
  cursor:pointer;
}
.s-item:hover{transform:translateY(-1px);box-shadow:0 16px 36px rgba(2,6,23,.10)}
.s-item[disabled]{opacity:.55;pointer-events:none}
.s-ico{
  width:36px;height:36px;border-radius:999px;display:grid;place-items:center;flex:0 0 auto;
  background:radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.92) 0%, rgba(255,255,255,.6) 45%, rgba(255,255,255,.38) 100%),
             linear-gradient(135deg, rgba(11,95,255,.18), rgba(14,165,233,.18));
  border:1px solid rgba(11,95,255,.25);
}
.s-item span{font-weight:700;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Activo */
.s-item.active{
  background:linear-gradient(180deg,#ffffff,#f6fbff);
  border-color:rgba(11,95,255,.28);
  box-shadow:0 14px 34px rgba(14,165,233,.20);
  color:#0b3aa6;
}

/* Zona inferior (login) */
.s-bottom{margin-top:auto;padding:6px;display:flex;flex-direction:column;gap:8px}
.s-google{
  padding:6px;border-radius:999px;background:rgba(255,255,255,.9);
  border:1px solid rgba(11,95,255,.18);box-shadow:0 6px 16px rgba(2,6,23,.08);
}
.s-status{font-size:12px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Ocultar etiquetas cuando está colapsado (desktop fuera de hover) */
.sidebar:not(:hover) .s-item span,
.sidebar:not(:hover) .s-title,
.sidebar:not(:hover) .s-status{display:none}
.sidebar:not(:hover) .s-wrap{padding:10px 8px}

/* Toggle móvil y scrim */
#sbToggle{
  position:fixed;left:12px;bottom:12px;z-index:121;
  width:48px;height:48px;border-radius:999px;border:1px solid rgba(11,95,255,.18);
  background:linear-gradient(135deg,#0b5fff,#0ea5e9);color:#fff;font-weight:800;
  box-shadow:0 12px 28px rgba(14,165,233,.35);cursor:pointer;display:none;
  padding-bottom: env(safe-area-inset-bottom, 0px);
}
#sbScrim{
  position:fixed;inset:0;background:rgba(2,6,23,.35);backdrop-filter:blur(2px);
  display:none;z-index:119;
}

/* Móvil: cerrar completamente y abrir con botón */
@media (max-width:900px){
  body{padding-left:0}
  .sidebar{
    transform:translateX(calc(-100% - 28px));  /* AHORA SE CIERRA DEL TODO */
    width:min(86vw,var(--sb-expanded));
  }
  .sidebar.open{transform:translateX(0)}
  #sbToggle{display:block}
  #sbScrim.show{display:block}
}

/* ========== CONTENIDO ========== */

/* Header */
.header-hero{padding:34px 0 18px;text-align:center}
.title{
  font-size:clamp(28px, 6.2vw, 44px);
  line-height:1.05;font-weight:900;letter-spacing:-.02em;margin:10px 0 8px;
  background:linear-gradient(120deg,#0b5fff 0%,#0ea5e9 35%,#0b5fff 70%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
  position:relative;display:inline-block;
}
.title::after{
  content:"";display:block;height:8px;border-radius:999px;margin:10px auto 0;
  width:58%;background:linear-gradient(90deg,rgba(11,95,255,.45),rgba(14,165,233,.35));filter:blur(2px);
}
.header-hero .subtitle{color:var(--muted);max-width:780px;margin:8px auto 0;padding:0 6px}

/* Plantillas */
.templates{margin-top:18px;display:flex;justify-content:center;gap:18px;flex-wrap:wrap}
.template{display:flex;flex-direction:column;align-items:center;gap:10px;width:96px;cursor:pointer;user-select:none}
.icon-glass{
  width:68px;height:68px;border-radius:50%;
  background:radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.55) 45%, rgba(255,255,255,.35) 100%),
             linear-gradient(135deg, rgba(11,95,255,.18), rgba(14,165,233,.18));
  border:1px solid rgba(11,95,255,.25);
  backdrop-filter:saturate(1.35) blur(12px);-webkit-backdrop-filter:saturate(1.35) blur(12px);
  box-shadow:var(--shadow-md), inset 0 1px 0 rgba(255,255,255,.6);
  display:grid;place-items:center;
  transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease;
}
.icon-glass:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-color:rgba(11,95,255,.35)}
.template .name{font-size:12px;font-weight:700;color:#0b3aa6;text-align:center}

/* Chat */
.canvas{min-height:calc(100vh - 176px);display:grid;place-items:stretch;margin-top:10px}
.chat{
  position:relative;overflow:hidden;border-radius:var(--radius-2xl);
  padding:0;display:grid;grid-template-rows:1fr auto;height:72vh;
}
.chat .bg{position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(800px 600px at 15% 20%, rgba(11,95,255,.12), transparent 60%),
             radial-gradient(700px 600px at 85% 10%, rgba(14,165,233,.10), transparent 60%),
             radial-gradient(900px 700px at 50% 100%, rgba(11,95,255,.10), transparent 60%)}
.chat .surface{position:absolute;inset:0;padding:18px;display:flex;flex-direction:column}
.chat .pane{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px;-webkit-overflow-scrolling:touch}
.msg{
  max-width:68ch;padding:12px 14px;border-radius:16px;box-shadow:var(--shadow-sm);
  border:1px solid rgba(11,95,255,.12);background:#fff;line-height:1.35;
}
.msg.user{align-self:flex-end;background:linear-gradient(135deg,#ffffff,#f6fbff);border-color:rgba(14,165,233,.25)}
.msg.assistant{align-self:flex-start}
.msg.system{align-self:center;font-size:13px;color:var(--muted);background:rgba(255,255,255,.6)}

.composer{
  display:flex;gap:10px;padding:10px;border-top:1px solid rgba(11,95,255,.1);
  background:rgba(255,255,255,.75);backdrop-filter:blur(8px);
  border-bottom-left-radius:var(--radius-2xl);border-bottom-right-radius:var(--radius-2xl);
  padding-bottom:calc(10px + env(safe-area-inset-bottom, 0px));
}
.input{flex:1;display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:#fff;border:1px solid rgba(11,95,255,.18);border-radius:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.7)}
.input textarea{width:100%;border:0;outline:0;resize:none;max-height:180px;font:500 15px/1.4 var(--font);color:var(--text)}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 0}
.chip{padding:6px 10px;border-radius:999px;background:rgba(14,165,233,.12);
  border:1px solid rgba(11,95,255,.25);color:#0b3aa6;font-weight:700;font-size:12px;cursor:pointer}

/* Secciones inferiores */
.section{padding:30px 0}
.grid{display:grid;gap:16px}
.grid.cards{grid-template-columns:repeat(auto-fill, minmax(280px, 1fr))}
.card{padding:18px;border-radius:var(--radius-xl);background:rgba(255,255,255,.78);border:1px solid rgba(11,95,255,.14);box-shadow:var(--shadow-sm)}
.card .k{font-weight:700;font-size:12px;color:#0b3aa6}
.card .v{font-weight:600}

/* Modales base */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90}
.modal.active{display:flex}
.modal .scrim{position:absolute;inset:0;background:rgba(2,6,23,.35);backdrop-filter:blur(6px)}
.dialog{
  position:relative;width:min(720px, 96vw);max-height:86vh;overflow:auto;padding:18px;
  border-radius:var(--radius-2xl);box-shadow:var(--shadow-lg);background:rgba(255,255,255,.9);
  border:1px solid rgba(11,95,255,.25);
}

/* Preview modal */
.preview-modal .sheet{
  position:relative;width:min(1200px,96vw);height:min(86vh, 900px);background:rgba(255,255,255,.96);
  border-radius:var(--radius-2xl);border:1px solid rgba(11,95,255,.25);box-shadow:var(--shadow-lg);overflow:hidden;
  display:grid;grid-template-rows:auto 1fr;
}
.preview-modal .bar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;
  background:linear-gradient(0deg, rgba(255,255,255,.8), rgba(255,255,255,.9));
  border-bottom:1px solid rgba(11,95,255,.15);
}
.preview-modal .actions{display:flex;gap:8px;flex-wrap:wrap}
.preview-modal iframe{width:100%;height:100%;border:0}
.preview-modal pre{
  display:none;margin:0;padding:14px;height:100%;overflow:auto;background:#0b1220;color:#e5e7eb;
  font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
.preview-modal.show-code iframe{display:none}
.preview-modal.show-code pre{display:block}

/* =========================
   Responsive ajustes extra
   ========================= */
@supports (height: 100dvh){
  .canvas{min-height:calc(100dvh - 176px)}
  .chat{height:68dvh}
  .dialog{max-height:86dvh}
  .preview-modal .sheet{height:min(86dvh, 900px)}
}
@media (max-width:1024px){
  .container{padding:0 16px}
  .grid.cards{grid-template-columns:repeat(auto-fill, minmax(240px, 1fr))}
}
@media (max-width:768px){
  :root{--glass-blur:18px;--radius-2xl:22px}
  .header-hero{padding:22px 0 12px}
  .title{font-size:clamp(24px, 8vw, 34px)}
  .title::after{height:6px;width:64%}
  .templates{gap:14px}
  .template{width:86px}
  .icon-glass{width:60px;height:60px}
  .canvas{margin-top:6px}
  .chat{border-radius:18px}
  .chat .surface{padding:12px}
  .composer{flex-wrap:wrap;gap:8px;padding:8px 8px calc(8px + env(safe-area-inset-bottom, 0px))}
  .composer .input{flex-basis:100%;padding:8px 10px}
  #send{width:100%;justify-content:center}
  .chips{gap:6px}
  .chip{font-size:11px;padding:6px 9px}
  .grid.cards{grid-template-columns:1fr}
  .card{padding:14px}
  .badge{font-size:11px;padding:5px 10px}
  .preview-modal .actions .btn{padding:10px 14px}
  .dialog{width:96vw;padding:14px}
  .preview-modal .bar{flex-wrap:wrap}
}
@media (prefers-reduced-motion:reduce){
  .btn,.icon-glass,.s-item{transition:none}
  .btn:hover,.s-item:hover{transform:none}
}
@media (max-width:1024px){ body{background-attachment:scroll} }
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <!-- ===== NAV LATERAL (VIDRIO) ===== -->
  <div id="sbScrim"></div>
  <aside class="sidebar" role="navigation" aria-label="PsicoFunnel sidebar" id="sidebar">
    <div class="s-wrap">
      <div class="s-head">
        <a class="s-logo" href="#">
          <div class="logo" aria-hidden="true"></div>
          <div class="s-title">PsicoFunnel</div>
        </a>
        <span class="badge" id="healthBadge" title="Estado de API">● Listo</span>
      </div>

      <nav class="s-nav">
        <a class="s-item active" href="#" title="Creador">
          <div class="s-ico" aria-hidden="true">
            <!-- magic wand -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M4 13l6 6M3 3l4 1-1 4-4-1 1-4Zm14-2l2 1-1 2-2-1 1-2Zm1 8l3 1-1 3-3-1 1-3Z" stroke="#0b5fff" stroke-width="1.5" stroke-linecap="round"/>
              <rect x="8" y="8" width="11" height="3" rx="1.5" transform="rotate(45 8 8)" fill="#0ea5e9"/>
            </svg>
          </div>
          <span>Creador</span>
        </a>

        <a class="s-item" href="/psiconstructor/crm" title="Leads (CRM)">
          <div class="s-ico" aria-hidden="true">
            <!-- users -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="9" cy="8" r="3" stroke="#0b5fff" stroke-width="1.5"/>
              <path d="M3 18c.6-2.8 3.2-4 6-4s5.4 1.2 6 4" stroke="#0ea5e9" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="17.5" cy="9.5" r="2" stroke="#0ea5e9" stroke-width="1.3"/>
            </svg>
          </div>
          <span>Leads</span>
        </a>

        <button class="s-item" disabled title="MVP: próximamente">
          <div class="s-ico" aria-hidden="true">
            <!-- flow -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M5 7h6a3 3 0 0 1 0 6H8" stroke="#0b5fff" stroke-width="1.5" stroke-linecap="round"/>
              <circle cx="5" cy="7" r="2.4" fill="#0ea5e9"/>
              <circle cx="8" cy="13" r="2.4" fill="#0ea5e9"/>
            </svg>
          </div>
          <span>Secuencias</span>
        </button>

        <button class="s-item" disabled title="MVP: próximamente">
          <div class="s-ico" aria-hidden="true">
            <!-- analytics -->
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M5 15v4M11 11v8M17 7v12" stroke="#0b5fff" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
          </div>
          <span>Analytics</span>
        </button>
      </nav>

      <div class="s-bottom">
        <div id="btnGoogle" class="s-google"></div>
        <div class="s-status hint" id="loginStatus">No has iniciado sesión</div>
      </div>
    </div>
  </aside>

  <!-- Toggle móvil -->
  <button id="sbToggle" aria-label="Abrir menú">☰</button>

  <!-- MODAL LOGIN (liquid glass) -->
  <div class="modal" id="loginModal" aria-hidden="true" role="dialog">
    <div class="scrim" data-close-login></div>
    <div class="dialog glass" style="max-width:560px">
      <div style="display:flex; flex-direction:column; align-items:center; text-align:center; gap:14px; padding:8px">
        <div class="logo" aria-hidden="true"></div>
        <h2 style="margin:0; font-size:22px; letter-spacing:-.02em">Inicia sesión para continuar</h2>
        <p class="hint" style="margin:0">Conéctate con Google para generar tu landing y asociarla a tu cuenta.</p>
        <div id="btnGoogleModal" style="display:flex; justify-content:center"></div>
        <div class="hint" id="loginStatusModal">Tu correo no está conectado.</div>
        <button class="btn ghost" data-close-login style="margin-top:6px">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="header-hero container">
    <h1 class="title">¿Qué funnel vamos a diseñar hoy?</h1>
    <p class="subtitle">Usa el chat a continuación para describir tu landing. O elige una plantilla rápida.
      <br>Cuando estés listo, haz clic en <strong>Creamos tu funnel</strong> para completar el brief de marca.</p>

    <div class="templates" id="templates">
      <div class="template" data-template="optin" data-sections='["hero","benefits","leadform","faq","footer"]' data-prompt="Crea una landing opt-in simple para captar emails, con un lead magnet descargable.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 7.5l9 6 9-6" stroke="#0b5fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
          </svg>
        </div>
        <div class="name">Opt-in</div>
      </div>

      <div class="template" data-template="vsl" data-sections='["hero","how","leadform","pricing","faq","footer"]' data-prompt="Crea una página VSL con un video central, bullets, prueba social mínima y CTA al formulario.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M10 9.5l5 2.5-5 2.5V9.5z" fill="#0b5fff"/>
          </svg>
        </div>
        <div class="name">VSL</div>
      </div>

      <div class="template" data-template="webinar" data-sections='["hero","steps","leadform","faq","footer"]' data-prompt="Crea registro a webinar con fecha/horario, bullets de valor y agenda de 3 puntos.">
        <div class="icon-glass" aria-hidden="true">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <rect x="3" y="5" width="18" height="14" rx="2.2" stroke="#0ea5e9" stroke-width="1.4"/>
            <path d="M3 9h18" stroke="#0b5fff" stroke-width="1.4"/>
            <circle cx="9" cy="13" r="1.4" fill="#0b5fff"/><circle cx="15" cy="13" r="1.4" fill="#0ea5e9"/>
          </svg>
        </div>
        <div class="name">Webinar</div>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="btn" id="openBrief">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
        Creamos tu funnel
      </button>
      <button class="btn ghost" id="loadDemo">Cargar demo rápida</button>
    </div>
  </header>

  <!-- CHAT -->
  <main class="container canvas">
    <section class="chat glass" aria-label="Creador tipo chat">
      <div class="bg" aria-hidden="true"></div>
      <div class="surface">
        <div id="pane" class="pane" role="log" aria-live="polite" aria-label="Mensajes del chat">
          <div class="msg system">Consejo: selecciona una plantilla arriba para autocompletar el prompt o escribe libremente.</div>
        </div>
        <div class="composer">
          <div class="input" style="flex:1">
            <textarea id="composer" rows="1" placeholder="Describe tu funnel… (Shift+Enter para salto de línea)"></textarea>
          </div>
          <button class="btn" id="send" aria-label="Enviar prompt y generar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 12l16-8-7 16-2-7-7-1z" stroke="white" stroke-width="2" stroke-linejoin="round"/></svg>
            Generar
          </button>
        </div>
        <div class="chips" id="chips">
          <div class="chip">Añade FAQ</div>
          <div class="chip">Incluye garantía 7 días</div>
          <div class="chip">Tono profesional y claro</div>
          <div class="chip">CTA con beneficio</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ÚLTIMAS LANDINGS + IDEAS -->
  <section class="container section" id="recentSection">
    <h3 style="margin:0 0 10px; font-size:20px">Últimas landings generadas</h3>
    <div class="grid cards" id="recentGrid" aria-live="polite"></div>
    <hr class="sep">
    <h3 style="margin:0 0 10px; font-size:20px">Ideas y plantillas recomendadas</h3>
    <div class="grid cards" id="ideasGrid">
      <div class="card"><div class="k">Opt-in con lead magnet</div><div class="hint">Ebook, checklist o mini-curso. Conversión esperada 3-7% con tráfico templado.</div></div>
      <div class="card"><div class="k">VSL con CTA a agenda</div><div class="hint">Video 3-7 min + prueba social breve. Ideal coaches/agencias.</div></div>
      <div class="card"><div class="k">Webinar evergreen</div><div class="hint">Registro + confirmación + replay. Secuencia 0/60/120s.</div></div>
      <div class="card"><div class="k">Checkout + garantía</div><div class="hint">Precio claro, bullets de valor, preguntas frecuentes.</div></div>
    </div>
  </section>

  <!-- MODAL BRIEF -->
  <div class="modal" id="briefModal" aria-hidden="true" aria-labelledby="briefTitle" role="dialog">
    <div class="scrim" data-close></div>
    <div class="dialog">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
        <div>
          <div class="badge">Brief de marca</div>
          <h2 id="briefTitle" style="margin:8px 0 2px">Completemos tu brief</h2>
          <div class="hint">Estos datos se usarán como default al generar tu funnel.</div>
        </div>
        <button class="btn ghost" data-close aria-label="Cerrar">Cerrar</button>
      </div>
      <form id="briefForm" class="form-grid">
        <div>
          <label class="label">Nombre de marca</label>
          <input class="input-txt" name="brand_name" required placeholder="Ej. PsicoFunnel">
        </div>
        <div>
          <label class="label">Nicho</label>
          <input class="input-txt" name="niche" placeholder="Ej. Coaching de hábitos">
        </div>
        <div>
          <label class="label">Objetivo</label>
          <input class="input-txt" name="goal" placeholder="Ej. Captar leads para sesión diagnóstica">
        </div>
        <div>
          <label class="label">Tono</label>
          <input class="input-txt" name="tone" placeholder="Ej. Positivo, claro, sin promesas vacías">
        </div>
        <div class="full" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <div style="min-width:140px; flex:1">
            <label class="label">Color primario</label>
            <input class="input-txt" name="color_primary" value="#0ea5e9">
          </div>
          <div style="min-width:140px; flex:1">
            <label class="label">Color acento</label>
            <input class="input-txt" name="color_accent" value="#0b5fff">
          </div>
          <div style="flex:2; min-width:200px">
            <label class="label">Estilo / keywords</label>
            <input class="input-txt" name="style_keywords" placeholder="liquid glass, minimalista, premium">
          </div>
        </div>
        <div>
          <label class="label">Precio (opcional)</label>
          <input class="input-num" type="number" min="0" step="1" name="offer_price" placeholder="49">
        </div>
        <div>
          <label class="label">Garantía (opcional)</label>
          <input class="input-txt" name="offer_guarantee" placeholder="Garantía 7 días">
        </div>
        <div class="full" style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px; flex-wrap:wrap">
          <button type="button" class="btn ghost" id="briefReset">Reset</button>
          <button type="submit" class="btn">Guardar brief</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL PREVIEW -->
  <div class="modal preview-modal" id="previewModal" aria-hidden="true" role="dialog">
    <div class="sheet">
      <div class="bar">
        <div class="pills">
          <span class="pill">Preview</span>
          <span class="pill" id="toggleCode">Ver código</span>
        </div>
        <div class="actions">
          <button class="btn ghost" id="downloadHTML">Descargar HTML</button>
          <button class="btn ghost" id="openNewTab">Abrir en pestaña</button>
          <button class="btn" id="closePreview">Cerrar</button>
        </div>
      </div>
      <iframe id="previewFrame" title="Vista previa de la landing"></iframe>
      <pre id="codeBox"></pre>
    </div>
  </div>

<script defer>
/* =========================
   PsicoFunnel — Home MVP JS
   ========================= */
const MAKE_URL = 'https://hook.us2.make.com/un34h9dqpi6qxcpclphk9rfav8fcvo1v';
const CRM_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzWAIlXAlJURfqDeUBgyFAeojocv-eciJ6FpVsS9lKbp_V5IsPwDTXQjLiTuxNie9taIg/exec';
const CRM_KEY = 'pon-un-secreto-simple-aqui';

/* ===== GSI ===== */
const CLIENT_ID = "63285262932-aadkqkcj3c117jrj9epfvtqkaiivdl7s.apps.googleusercontent.com";
let ID_TOKEN = null;
let USER_EMAIL = null;
let USER_NAME = null;

const $ = (s,el=document)=>el.querySelector(s);
const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));

function b64urlToUtf8(b64url){
  let b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
  const pad = b64.length % 4; if(pad) b64 += '='.repeat(4-pad);
  const bin = atob(b64);
  try{
    return decodeURIComponent(Array.from(bin, c => '%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join(''));
  }catch(_){ return bin; }
}
function decodeJwtPayload(token){
  try{ return JSON.parse(b64urlToUtf8(token.split('.')[1]||'')) }catch(_){ return {} }
}
function setLoginModal(open){
  const m = $('#loginModal');
  m.classList.toggle('active', !!open);
  m.setAttribute('aria-hidden', open ? 'false' : 'true');
}
function ensureLogged(){
  if(ID_TOKEN) return true;
  setLoginModal(true);
  return false;
}

async function apiWhoAmI(idToken){
  const u = new URL(CRM_ENDPOINT);
  u.searchParams.set('action','whoami');
  u.searchParams.set('id_token', idToken);
  const r = await fetch(u); return r.json();
}

window.addEventListener('load', async () => {
  if(window.google && google.accounts && google.accounts.id){
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleSignIn });
    const btn = $('#btnGoogle');
    if(btn) google.accounts.id.renderButton(btn, { theme:'outline', size:'medium', type:'standard', shape:'pill' });
    const btnM = $('#btnGoogleModal');
    if(btnM) google.accounts.id.renderButton(btnM, { theme:'filled_blue', size:'large', type:'standard', shape:'pill', text:'signin_with' });
  }
  // Reusar token
  try{
    const t = localStorage.getItem('psico_id_token');
    const n = localStorage.getItem('psico_name');
    const e = localStorage.getItem('psico_email');
    if(t){
      const w = await apiWhoAmI(t).catch(()=>({ok:false}));
      if(w.ok){
        ID_TOKEN = t;
        USER_EMAIL = w.email || e || null;
        USER_NAME  = n || null;
        document.body.classList.add('logged');
        const ls = $('#loginStatus'); if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
      }else{
        localStorage.removeItem('psico_id_token'); localStorage.removeItem('psico_email'); localStorage.removeItem('psico_name');
      }
    }
  }catch(_){}
});

async function onGoogleSignIn(resp){
  const claims = decodeJwtPayload(resp.credential || '');
  USER_NAME  = claims.name || [claims.given_name, claims.family_name].filter(Boolean).join(' ') || null;
  USER_EMAIL = claims.email || null;

  const ls = $('#loginStatus'); if(ls) ls.textContent = 'Verificando…';
  const w = await apiWhoAmI(resp.credential).catch(()=>({ok:false}));
  if(!w.ok){ if(ls) ls.textContent = w.error || 'No autorizado'; return; }

  ID_TOKEN = resp.credential;
  USER_EMAIL = w.email || USER_EMAIL;
  localStorage.setItem('psico_id_token', ID_TOKEN);
  if(USER_EMAIL) localStorage.setItem('psico_email', USER_EMAIL);
  if(USER_NAME)  localStorage.setItem('psico_name', USER_NAME);

  document.body.classList.add('logged');
  if(ls) ls.textContent = 'Conectado: ' + USER_EMAIL;
  const lsm = $('#loginStatusModal'); if(lsm) lsm.textContent = 'Conectado: ' + USER_EMAIL;
  setLoginModal(false);
}

// Cerrar modal login
document.addEventListener('click', (e)=>{
  if(e.target.closest('[data-close-login]')) setLoginModal(false);
});

/* ===== UI Refs ===== */
const healthBadge = $('#healthBadge');
const pane = $('#pane');
const composer = $('#composer');
const sendBtn = $('#send');
const openBriefBtn = $('#openBrief');
const loadDemoBtn = $('#loadDemo');
const recentGrid = $('#recentGrid');

/* Preview modal elems */
const previewModal = $('#previewModal');
const previewFrame = $('#previewFrame');
const codeBox = $('#codeBox');
const toggleCodeBtn = $('#toggleCode');
const downloadBtn = $('#downloadHTML');
const openTabBtn = $('#openNewTab');
const closePreviewBtn = $('#closePreview');

/* Estado */
let selectedTemplate = null;
let lastHTML = '';
let lastBlobURL = '';

/* Stores */
const BriefStore = {
  key: 'pf_brief_v1',
  get(){ try { return JSON.parse(localStorage.getItem(this.key)||'null') } catch { return null } },
  set(d){ localStorage.setItem(this.key, JSON.stringify(d||{})); },
  reset(){ localStorage.removeItem(this.key); }
};
const RecentStore = {
  key: 'pf_recent_sites_v1',
  list(){ try { return JSON.parse(localStorage.getItem(this.key)||'[]') } catch { return [] } },
  push(item){ const arr = this.list(); arr.unshift(item); localStorage.setItem(this.key, JSON.stringify(arr.slice(0,12))); }
};
const SessionHTML = new Map(); // slug -> {html, blobURL}

/* Salud simple */
if(healthBadge){
  healthBadge.textContent = '● Listo';
  healthBadge.style.color = 'var(--success)';
}

/* Utils */
function addMsg(role, html){
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = html;
  pane.appendChild(div);
  pane.scrollTop = pane.scrollHeight;
  return div;
}
function setModal(open){
  const briefModal = $('#briefModal');
  briefModal.classList.toggle('active', !!open);
  briefModal.setAttribute('aria-hidden', open ? 'false' : 'true');
  if(open){ setTimeout(()=> $("[name='brand_name']", briefModal)?.focus(), 50) }
}
function setPreview(open){
  previewModal.classList.toggle('active', !!open);
  previewModal.setAttribute('aria-hidden', open ? 'false' : 'true');
}

/* Plantillas (requiere login) */
$('#templates').addEventListener('click', (e)=>{
  if(!ensureLogged()){ addMsg('system','Inicia sesión para seleccionar una plantilla.'); return; }
  const item = e.target.closest('.template');
  if(!item) return;
  selectedTemplate = {
    name: item.dataset.template,
    sections: JSON.parse(item.dataset.sections||'[]'),
    prompt: item.dataset.prompt || ''
  };
  composer.value = selectedTemplate.prompt;
  addMsg('assistant', `Plantilla <strong>${selectedTemplate.name}</strong> seleccionada. Puedes editar el prompt y presionar <em>Generar</em>.`);
});

/* Chips */
$('#chips').addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip'); if(!chip) return;
  const add = chip.textContent.trim();
  const cur = composer.value.trim();
  composer.value = cur ? cur + (cur.endsWith('.')?'':'') + ' ' + add + '.' : add + '.';
  composer.focus();
});

/* Brief (requiere login) */
openBriefBtn.addEventListener('click', ()=>{
  if(!ensureLogged()){ addMsg('system','Inicia sesión para completar tu brief.'); return; }
  const briefModal = $('#briefModal');
  const saved = BriefStore.get() || {};
  $$('[name]', briefModal).forEach(inp=>{
    const k = inp.name; if(saved[k] != null) inp.value = saved[k];
  });
  setModal(true);
});
document.addEventListener('click', (e)=>{
  if(e.target.closest('[data-close]')) setModal(false);
});
$('#briefReset').addEventListener('click', ()=>{
  const briefModal = $('#briefModal');
  BriefStore.reset();
  $$('[name]', briefModal).forEach(inp=> inp.value = '');
});
$('#briefForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const briefModal = $('#briefModal');
  const data = Object.fromEntries(new FormData(e.target).entries());
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_primary||'')) data.color_primary = '#0ea5e9';
  if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(data.color_accent||'')) data.color_accent = '#0b5fff';
  BriefStore.set(data);
  addMsg('assistant', '✅ Brief guardado. Ya podemos generar con tu marca por defecto.');
  setModal(false);
});

/* Recientes */
function renderRecents(){
  const arr = RecentStore.list();
  recentGrid.innerHTML = '';
  if(!arr.length){
    recentGrid.innerHTML = `<div class="card"><div class="k">Aún no hay landings</div><div class="hint">Cuando generes tu primera landing, aparecerá aquí.</div></div>`;
    return;
  }
  arr.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="k">${it.title || 'Landing generada'}</div>
      <div class="hint" style="margin:6px 0 10px">Slug: <strong>${it.slug}</strong> • Fecha: ${new Date(it.ts).toLocaleString()}</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn" data-open="${it.slug}">Abrir</button>
        <button class="btn ghost" data-copy="${it.slug}">Copiar código</button>
      </div>`;
    recentGrid.appendChild(card);
  });
}
recentGrid.addEventListener('click', async (e)=>{
  const open = e.target.closest('[data-open]');
  const copy = e.target.closest('[data-copy]');
  if(open){
    const slug = open.getAttribute('data-open');
    const item = SessionHTML.get(slug);
    if(!item){ open.textContent='No disponible'; return; }
    window.open(item.blobURL, '_blank', 'noopener');
  }
  if(copy){
    const slug = copy.getAttribute('data-copy');
    const item = SessionHTML.get(slug);
    if(!item){ copy.textContent='No disponible'; return; }
    await navigator.clipboard.writeText(item.html);
    copy.textContent='¡Copiado!';
    setTimeout(()=> copy.textContent='Copiar código', 1200);
  }
});

/* Envío a Make (evita preflight CORS) */
const TIMEOUT_MS = 60000;
function validHex(s){ return /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/.test((s||'').trim()); }

async function sendToMake(payload){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort('timeout'), TIMEOUT_MS);
  let r;
  try{
    r = await fetch(MAKE_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=UTF-8', 'Accept':'text/html' },
      body: JSON.stringify(payload),
      signal: ctrl.signal
    });
  }catch(e){
    clearTimeout(t);
    if(e.name === 'AbortError') throw new Error('Timeout del servidor (60s).');
    throw new Error('No se pudo conectar: ' + e.message);
  }
  clearTimeout(t);

  const html = await r.text();
  if(!r.ok) throw new Error('Status ' + r.status + '. ' + html.slice(0,200));
  if(!/^<!doctype html/i.test(html) || !/<\/html>/i.test(html)) throw new Error('La respuesta no es un HTML completo.');
  return html;
}

/* Generación (REQUIERE LOGIN) */
async function generateFromPrompt(){
  if(!ensureLogged()){ addMsg('system','Primero inicia sesión para generar.'); return; }

  const text = composer.value.trim();
  if(!text){ composer.focus(); addMsg('system','Escribe un prompt o elige una plantilla ☝️'); return; }

  const brief = BriefStore.get() || {
    brand_name:'PsicoFunnel Demo',
    niche:'coaches/cursos',
    goal:'captar leads',
    tone:'claro y profesional',
    color_primary:'#0ea5e9',
    color_accent:'#0b5fff',
    offer_price: 49,
    offer_guarantee: 'Garantía 7 días',
    style_keywords:'liquid glass, minimalista, premium'
  };
  if(!validHex(brief.color_primary) || !validHex(brief.color_accent)){
    addMsg('system','Color inválido. Usa formato #rrggbb.'); return;
  }
  const sections = (selectedTemplate?.sections) || ["hero","benefits","leadform","faq","footer"];
  const project_slug = (brief.brand_name || 'demo')
    .toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,40)
    + '-' + Math.random().toString(36).slice(2,6);

  const payload = {
    project_slug,
    brand: { name: brief.brand_name || 'PsicoFunnel', colors: { primary: brief.color_primary, accent: brief.color_accent } },
    niche: brief.niche || 'general',
    goal: brief.goal || 'captar leads',
    tone: brief.tone || 'claro y profesional',
    offer: { price: brief.offer_price ? String(brief.offer_price) : undefined, guarantee: brief.offer_guarantee || undefined },
    sections,
    prompt: text,
    crm_endpoint: CRM_ENDPOINT,
    crm_key: CRM_KEY,
    owner_email: USER_EMAIL || undefined,
    owner_name: USER_NAME || undefined,
    id_token: ID_TOKEN
  };

  addMsg('user', text);
  const thinking = addMsg('assistant', 'Generando tu funnel… ⏳');

  try{
    // Registrar proyecto (best-effort)
    try{
      const reg = await fetch(CRM_ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=UTF-8' },
        body: JSON.stringify({ action:'registerProject', id_token: ID_TOKEN, project_slug, owner_name: USER_NAME })
      }).then(r=>r.json());
      if(!reg.ok){ addMsg('system','No pude registrar tu proyecto en el CRM (continuamos de todos modos).'); }
    }catch(e){ addMsg('system','Error registrando en CRM (continuamos).'); }

    const html = await sendToMake(payload);
    thinking.remove();

    // Guardar para abrir/descargar
    if(lastBlobURL) URL.revokeObjectURL(lastBlobURL);
    lastHTML = html;
    lastBlobURL = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8'}));
    SessionHTML.set(project_slug, {html, blobURL:lastBlobURL});
    RecentStore.push({ slug: project_slug, title: (brief.brand_name||'Marca') + ' — ' + (selectedTemplate?.name || 'custom'), ts: Date.now() });
    renderRecents();

    // Preview
    previewFrame.removeAttribute('sandbox');
    previewFrame.srcdoc = html;
    codeBox.textContent = html;
    $('#previewModal').classList.remove('show-code');
    setPreview(true);

    addMsg('assistant', `Listo ✅ Abre la preview para ver/descargar tu landing.`);
    composer.value=''; selectedTemplate = null;
  }catch(err){
    thinking.textContent = 'Hubo un problema: ' + (err.message || err);
    if(String(err).includes('CORS')){
      addMsg('system','Parece CORS. Verifica el Webhook Response o usa un proxy /api/psico-make-generate.');
    }
  }
}

/* Eventos principales */
sendBtn.addEventListener('click', generateFromPrompt);
composer.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); generateFromPrompt(); }
});
loadDemoBtn.addEventListener('click', ()=>{
  composer.value = "Crea una landing opt-in para un checklist de productividad (3 beneficios y FAQ). Tono claro, profesional, sin promesas vacías. CTA a ‘Recibir mi checklist’.";
  addMsg('assistant','Cargué un prompt de ejemplo. ¡Dale a Generar!');
});

/* Preview modal actions */
toggleCodeBtn?.addEventListener('click', ()=> $('#previewModal').classList.toggle('show-code'));
downloadBtn?.addEventListener('click', ()=>{
  if(!lastHTML.trim()) return;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([lastHTML], {type:'text/html;charset=utf-8'}));
  a.download = 'index.html';
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
});
openTabBtn?.addEventListener('click', ()=>{ if(lastBlobURL) window.open(lastBlobURL,'_blank','noopener'); });
closePreviewBtn?.addEventListener('click', ()=> setPreview(false));

/* Sidebar móvil toggle */
(function(){
  const sb = document.getElementById('sidebar');
  const btn = document.getElementById('sbToggle');
  const scrim = document.getElementById('sbScrim');
  function openSB(){ sb.classList.add('open'); scrim.classList.add('show'); }
  function closeSB(){ sb.classList.remove('open'); scrim.classList.remove('show'); }
  btn?.addEventListener('click', ()=> sb.classList.contains('open') ? closeSB() : openSB());
  scrim?.addEventListener('click', closeSB);
})();

/* Inicial */
renderRecents();
</script>
</body>
</html>
